//@version=5
// Wyckoff-SMC Hybrid v5.2 - Patched & Upgraded
indicator("Wyckoff-SMC Hybrid [v5.2 Patched]", "WSH v5.2", overlay=true, max_labels_count=500, max_boxes_count=200)

// =============================================================================
// I. INPUTS â€” giá»¯ nguyÃªn cá»‘t lÃµi WSH + thÃªm nháº¹ cho scalper
// =============================================================================
// --- 0. General Settings ---
style_group = "0. General Settings"  // removed corrupted suffix containing 'ÃŠ'
core_group  = "1. Wyckoff Core Engine"
poi_struct_group = "2. POI & Structural"
entry_group = "3. Entry & Risk"
risk_group  = entry_group
scalp_group = "4. Scalper Filters"
score_group = "5. Scoring"
trading_style = input.string(
     defval="Scalping",
     title="Trading Style",
     options=["Day/Swing Trading", "Scalping"],
     group=style_group,
     tooltip="Tá»± Ä‘á»™ng Ã¡p dá»¥ng cÃ¡c thÃ´ng sá»‘ phÃ¹ há»£p cho phong cÃ¡ch giao dá»‹ch cá»§a báº¡n."
)
color_candles = input.bool(true, "Color Candles by Momentum (EMA21)?", group=style_group)
show_wyckoff_labels= input.bool(true, "Show Event Labels", group=core_group)
// --- 1. Wyckoff Core Engine ---olume Lookback", minval=10, group=core_group)
core_group = "1. Wyckoff Core Engine"lume Spike Multiplier (Crypto)", minval=1.0, step=0.1, group=core_group)
show_bg    = input.bool(true, title="Show Phase Background", group=core_group)inval=1.0, step=0.1, group=core_group)
show_wyckoff_labels= input.bool(true, title="Show Event Labels (SC, SP..)", group=core_group)
analysis_mode = input.string(trading_style == "Scalping" ? "Micro" : "Macro", "Analysis Mode", options=["Macro", "Micro"], group=core_group, tooltip="Macro: Logic Wyckoff Ä‘áº§y Ä‘á»§.\nMicro: Logic tÄƒng tá»‘c dá»±a trÃªn Sweep.") trÃªn Sweep thanh khoáº£n, nháº¡y hÆ¡n cho scalping.")
// --- 2. Points of Interest (POI) (GIá»® NGUYÃŠN) ---
// --- Parameter Presets based on Trading Style ---
is_scalping = trading_style == "Scalping"y Level (KV) Zones", group=poi_group)
vol_lookback_def = is_scalping ? 30 : 50rder Block (OB) Zones", group=poi_group)
vol_mult_def     = is_scalping ? 1.8 : 2.2Highlight Contextual POIs", group=poi_group)
range_mult_def   = is_scalping ? 1.6 : 2.0tend POI (bars)", group=poi_group)
pivot_len_def    = is_scalping ? 4 : 8"Max Active POI zones", group=poi_group, tooltip="Sá»‘ lÆ°á»£ng vÃ¹ng POI gáº§n nháº¥t Ä‘Æ°á»£c giá»¯ láº¡i Ä‘á»ƒ trÃ¡nh lÃ m cháº­m chart.")
micro_range_len_def = is_scalping ? 40 : 100back", minval=2, group=poi_group)
kv_wick_mult   = input.float(1.0, "KV Wick/Body Min Ratio", minval=0.1, step=0.1, group=poi_group)
vol_lookback   = input.int(vol_lookback_def, "Volume Lookback", minval=10, group=core_group)
vol_mult       = input.float(vol_mult_def, "Volume Spike Multiplier", minval=1.0, step=0.1, group=core_group)
range_mult     = input.float(range_mult_def, "Climax Candle Range Multiplier", minval=1.0, step=0.1, group=core_group)
atr_len        = input.int(14, "ATR Length", group=core_group) group=struct_group)
micro_cooldown = input.int(5, "Micro Phase Cooldown (bars)", group=core_group, tooltip="Sá»‘ náº¿n tá»‘i thiá»ƒu má»™t pha Micro pháº£i tá»“n táº¡i trÆ°á»›c khi reset.") trÃ¡nh nháº¥p nhÃ¡y.")
pivot_len  = input.int(5, "Pivot Lookback", minval=2, group=struct_group)
// --- 2. POI & Structural ---at(0.1, "Liquidity Proximity (x ATR)", group=struct_group)
poi_struct_group = "2. POI & Structural"
show_kv_zones = input.bool(true, "Show Key Level (KV) Zones", group=poi_struct_group)
show_ob_zones = input.bool(true, "Show Order Block (OB) Zones", group=poi_struct_group)
show_sw_hl    = input.bool(true, "Show Strong/Weak Highs & Lows", group=poi_struct_group)oup)
poi_extend_bars = input.int(100, "Extend POI (bars)", group=poi_struct_group)roup)ruct_group)
poi_max_active_zones = input.int(10, "Max Active POI zones", group=poi_struct_group)
pivot_len  = input.int(pivot_len_def, "Pivot Lookback", minval=2, group=poi_struct_group)s=["60", "240", "D"])
kv_wick_mult  = is_scalping ? 1.0 : 1.2Pivot Lookback", minval=2, group=poi_struct_group)
// --- 5. Risk Management (GIá»® NGUYÃŠN) ---
// --- 3. Entry & Risk ---gement" 5
entry_group = "3. Entry & Risk"rue, "Show SL/TP Levels on Signal", group=risk_group)
show_entries = input.bool(true, "Show Final Buy/Sell Entries", group=entry_group)p=0.1)
show_traps   = input.bool(true, "Show NS/ND Signals", group=entry_group)sk_group, step=0.1)
entry_throttle = input.int(10, "Entry Signal Throttle (bars)", group=entry_group) step=0.1)
htf_confirm_tf = input.string("240", "HTF EMA Timeframe", group=entry_group, options=["60", "240", "D"])
use_momentum_filter = input.bool(true, "Use EMA21 Momentum Filter for Entry?", group=entry_group)
show_risk_levels = input.bool(false, "Show SL/TP Levels", group=entry_group) options=["60", "240", "D"])
sl_atr_mult  = input.float(1.5, "Stop Loss ATR Multiplier", group=entry_group, step=0.1)ry_group)
tp1_atr_mult = input.float(2.0, "Take Profit 1 ATR Multiplier", group=entry_group, step=0.1)
useRegime   = input.bool(true,  "Regime filter (ATR% + optional ADX)", group=scalp_group)
minATRpct   = input.float(0.50, "Min ATR14 % price (crypto scalp)", step=0.05, group=scalp_group)
// =============================================================================
// II. CORE LOGICut.int(18,     "ADX threshold", minval=10, maxval=50, group=scalp_group)
// =============================================================================
// --- Data & State ---(13,     "Session start (UTC)", minval=0, maxval=23, group=scalp_group)
vol_sma = ta.sma(volume, vol_lookback)on end (UTC)",   minval=1, maxval=24, group=scalp_group)
atr_val = ta.atr(atr_len)
var int   phase = 0 // 0:Neutral, 1:TR, 2:Accum, 3:Distrib
var float tr_high = naol(true,  "Liquidity sweep (reject at HH/LL)", group=scalp_group)
var float tr_low = naloat(0.6,  "Min wick ratio on sweep", step=0.05, group=scalp_group)
var int tr_start_bar = natrue,  "Volume Delta (tick-proxy) confirm", group=scalp_group)
var int last_event_bar = na     "Delta Z lookback", minval=20, group=scalp_group)
var int last_spring_bar = na
var int last_ut_bar = na na
var int last_sos_bar = natrue,  "Micro BOS/CHoCH (fast structure)", group=scalp_group)
var int last_sow_bar = na,      "Micro lookback", minval=2, group=scalp_group)
var float strong_high = na
var float strong_low = na0 bias)
var box[]  box_array = array.new_box(0)wn Gate (MA50 bias)", group=scalp_group)
var bool[] box_is_bull_array = array.new_bool(0)scalp_group)
var int micro_last_event_bar = naUse 4H", group=scalp_group)
use1H       = input.bool(true,  "Use 1H", group=scalp_group)
// --- Helper Functions ---ue,  "Use 30m", group=scalp_group)
f_add_label(bar, price, txt, style, color, txt_color) =>roup=scalp_group)
    if show_wyckoff_labels2.0,  "Weight 4H", step=0.5, group=scalp_group)
        label.new(bar, price, txt, style=style, color=color, textcolor=txt_color, size=size.small)
f_reset_phase() =>t.float(1.0,  "Weight 30m", step=0.5, group=scalp_group)
    phase := 0
    tr_high := nagateShortThr= input.float(2.5,  "Gate Short â‰¥ |Î£|", step=0.5, group=scalp_group), size=size.small)
    tr_low := na
    last_spring_bar := nanháº¹, chá»‰ cho entry)
    last_ut_bar := naght)"
    last_sos_bar := na)
    last_sow_bar := na
ut.float(1.0,  "NS/ND (Ä‘Ãºng hÆ°á»›ng)", step=0.5, group=score_group)
// --- Wyckoff Phase & Event Detection ---
if analysis_mode == "Macro"
    is_vol_spike = volume > vol_sma * vol_multut.float(1.0,  "Î” confirm (SPR/UT)", step=0.5, group=score_group)
    is_wide_range_bear = close < open and (open - close) > atr_val * range_mult
    is_wide_range_bull = close > open and (close - open) > atr_val * range_multe alignment", step=0.5, group=score_group)
    if phase == 0
        if is_wide_range_bear and is_vol_spike and low < ta.lowest(low, 20)[1]
            phase := 1ult
            tr_low := low
            tr_high := high
            tr_start_bar := bar_index
            last_event_bar := bar_index= low
            f_add_label(bar_index, low, "SC", label.style_label_up, color.new(color.red, 20), color.red)=======================
        if is_wide_range_bull and is_vol_spike and high > ta.highest(high, 20)[1]G SCALPER)
            phase := 1=======================
            tr_high := highbel_up, color.new(color.red, 20), color.red)
            tr_low := lowclamp(v,a,b) => math.max(a, math.min(b,v))e_bull and is_vol_spike and high > ta.highest(high, 20)[1] 
            tr_start_bar := bar_index= 1
            last_event_bar := bar_indexe (WSH) ---
            f_add_label(bar_index, high, "BC", label.style_label_down, color.new(color.green, 20), color.green)
    if phase == 1
        tr_high := math.max(tr_high, high)
        tr_low := math.min(tr_low, low)e < open and (open - close) > atr_val * range_multr.new(color.green, 20), color.green)
    if phase >= 1 and not na(tr_low) = close > open and (close - open) > atr_val * range_mult
        if low < tr_low and close > tr_low and bar_index > last_event_bar + 5
            phase := 2:Accum, 3:Distrib
            last_event_bar := bar_index
            last_spring_bar := bar_index close > tr_low and bar_index > last_event_bar + 5
            f_add_label(bar_index, low, "SP", label.style_label_up, color.new(color.green, 20), color.green)
        if high > tr_high and close < tr_high and bar_index > last_event_bar + 5
            phase := 3
            last_event_bar := bar_indexst_ut_bar = nar_index, low, "SP", label.style_label_up, color.new(color.green, 20), color.green)
            last_ut_bar := bar_index = nand close < tr_high and bar_index > last_event_bar + 5
            f_add_label(bar_index, high, "UT", label.style_label_down, color.new(color.red, 20), color.red)var int   last_sow_bar = na
        is_sos = close > tr_high and close > open and volume > vol_sma * 1.5ndex
        is_sow = close < tr_low and close < open and volume > vol_sma * 1.5
        if is_sos and phase < 3(color.red, 20), color.red)
            strong_low := tr_low
            strong_high := na
            last_sos_bar := bar_index< 3
            f_add_label(bar_index, high, "SOS", label.style_label_up, color.new(color.blue, 20), color.blue)
            f_reset_phase()
        if is_sow and phase < 2
            strong_high := tr_highh, "SOS", label.style_label_up, color.new(color.blue, 20), color.blue)
            strong_low := nahigh, 20)
            last_sow_bar := bar_indexlowest20_1    = bars_ready(1) ? lowest20_raw[1]  : na
            f_add_label(bar_index, low, "SOW", label.style_label_down, color.new(color.purple, 20), color.purple)20_raw[1] : na
            f_reset_phase()
else // "Micro" Mode(1, bar_index - tr_start_bar)
    micro_high = ta.highest(high, micro_range_len_def)[1]
    micro_low  = ta.lowest(low, micro_range_len_def)[1]
    is_sweep_low  = low < micro_low and close > micro_lowrange_highest = ta.highest(high, len_clamped)
    is_sweep_high = high > micro_high and close < micro_high> micro_range_len_def
)st(high, micro_range_len_def)[1]
    if is_sweep_lowity(syminfo.tickerid, htf_confirm_tf, close, barmerge.gaps_off, barmerge.lookahead_off)
        phase := 2
        last_spring_bar := bar_index // Use the main variable
        micro_last_event_bar := bar_indexf_ema50
        f_add_label(bar_index, low, "Î¼-SP", label.style_label_up, color.new(color.green, 20), color.green)
    else if is_sweep_high
        phase := 3
        last_ut_bar := bar_index // Use the main variable    if show_wyckoff_labelsnt_bar := bar_index
        micro_last_event_bar := bar_indextxt, style=style, color=clr, textcolor=txt_color, size=size.small), color.green)
        f_add_label(bar_index, high, "Î¼-UT", label.style_label_down, color.new(color.red, 20), color.red)
    // Debounce Micro phasecolor, p_style, string p_label) =>
    else if phase > 0 and not (is_sweep_low or is_sweep_high)
        if not na(micro_last_event_bar) and bar_index - micro_last_event_bar < micro_cooldown_event_bar := bar_index
            phase := phase // Giá»¯ nguyÃªn pha trong thá»i gian cooldowned, 20), color.red)
        else
            phase := 0 highlight_context_poi and is_contextual ? p_color : color.new(color.gray, 70)

// --- POI Drawing & Management ---
f_draw_poi_box(p_top, p_bottom, p_color, p_style, p_is_bull) =>        b = box.new(left_x, p_top, right_x, p_bottom, border_color=final_color, border_style=p_style, bgcolor=color.new(final_color, 85))
    is_contextual = (p_is_bull and phase == 2) or (not p_is_bull and phase == 3)
    final_color = highlight_context_poi and is_contextual ? p_color : color.new(color.gray, 70)
    b = box.new(bar_index[1], p_top, bar_index + poi_extend_bars, p_bottom, border_color=final_color, border_style=p_style, bgcolor=color.new(final_color, 85))
    array.push(box_array, b))2) or (not p_is_bull and phase == 3)
    array.push(box_is_bull_array, p_is_bull)
    if array.size(box_array) > poi_max_active_zoneser_style=p_style, bgcolor=color.new(final_color, 85))
        old_box = array.shift(box_array)
        array.shift(box_is_bull_array)
        box.delete(old_box)                array.unshift(box_array, old_box)es
array.unshift(box_is_bull, old_flag)
kv_zone_len_local = is_scalping ? 3 : 5
if show_kv_zones and bar_index > kv_zone_len_local:ompiler
    spread = math.max(high-low, syminfo.mintick)olid, "")
    if ta.crossunder(low, ta.lowest(low, kv_zone_len_local)[1]) and close > open and (math.min(open, close) - low) / spread >= kv_wick_mult: f_draw_poi_box(high[1], low[1], color.new(color.blue, 75), line.style_dashed, true)_len:
    if ta.crossover(high, ta.highest(high, kv_zone_len_local)[1]) and close < open and (high - math.max(open, close)) / spread >= kv_wick_mult: f_draw_poi_box(high[1], low[1], color.new(color.orange, 75), line.style_dashed, false)
 and (math.min(open, close) - low) / spread >= kv_wick_mult: f_draw_poi_box(high[1], low[1], color.new(color.blue, 75), line.style_dashed, true)
if show_ob_zonesnd low < lowest20_1 close < open and (high - math.max(open, close)) / spread >= kv_wick_mult: f_draw_poi_box(high[1], low[1], color.new(color.orange, 75), line.style_dashed, false)
    if not na(last_sos_bar)    phase := 1
        last_bear_idx = -1
        for i = 1 to 20
            if i < last_sos_bar and close[last_sos_bar-i] < open[last_sos_bar-i]
                last_bear_idx := last_sos_bar-i
            elsebar) and close[last_sos_bar-i] < open[last_sos_bar-i]
                if last_bear_idx != -1vol_spike and high > highest20_1   last_bear_idx := last_sos_bar-i
                    break
        if last_bear_idx != -1
            f_draw_poi_box(high[last_bear_idx], low[last_bear_idx], color.new(color.teal, 75), line.style_solid, true)
            last_sos_bar := na
    if not na(last_sow_bar)
        last_bull_idx = -1        f_add_label(bar_index, high, "BC", label.style_label_down, color.new(color.green, 20), color.green)
        for i = 1 to 20
            if i < last_sow_bar and close[last_sow_bar-i] > open[last_sow_bar-i]
                last_bull_idx := last_sow_bar-iw_bar-i]
            else
                if last_bull_idx != -1r_high) < atr_val * 0.2 and volume < vol_smalse if last_bull_idx != -1
                    breakw - tr_low)  < atr_val * 0.2 and volume < vol_sma
        if last_bull_idx != -1
            f_draw_poi_box(high[last_bull_idx], low[last_bull_idx], color.new(color.purple, 75), line.style_solid, false).style_label_down, color.new(color.gray, 20), color.gray)(color.purple, 75), line.style_solid, false)
            last_sow_bar := na

// --- Structural Analysis ---
p_high = ta.pivothigh(high, pivot_len, pivot_len)(tr_low)
p_low = ta.pivotlow(low, pivot_len, pivot_len)
if show_sw_hl and bar_index > pivot_len: volume < vol_sma * 0.8
    if not na(p_high):
        is_strong = not na(strong_high) and math.abs(p_high - strong_high) < atr_val * 0.1 last_event_bar := bar_index, last_spring_bar := bar_indexh) < atr_val * 0.1
        label.new(bar_index-pivot_len, p_high, is_strong ? "S-H" : "W-H ðŸŽ¯", style=label.style_label_down, color=is_strong ? color.new(color.maroon, 20):color.new(color.red,20), textcolor=color.white, size=size.tiny) color.new(color.green, 20), color.green)ðŸŽ¯", style=label.style_label_down, color=is_strong ? color.new(color.maroon, 20):color.new(color.red,20), textcolor=color.white, size=size.tiny)
    if not na(p_low):
        is_strong = not na(strong_low) and math.abs(p_low - strong_low) < atr_val * 0.1
        label.new(bar_index-pivot_len, p_low, is_strong ? "S-L" : "W-L ðŸŽ¯", style=label.style_label_up, color=is_strong ? color.new(color.navy, 20):color.new(color.green,20), textcolor=color.white, size=size.tiny)k and bar_index > last_event_bar + 5color=is_strong ? color.new(color.navy, 20):color.new(color.green,20), textcolor=color.white, size=size.tiny)



























































        tr_box := na        box.delete(tr_box)    if not na(tr_box)else        box.set_right(tr_box, bar_index)        box.set_bottom(tr_box, tr_low)        box.set_top(tr_box, tr_high)        box.set_left(tr_box, tr_start_bar)    else        tr_box := box.new(tr_start_bar, tr_high, bar_index, tr_low, border_color=color.new(color.gray, 50), bgcolor=na)    if na(tr_box)if analysis_mode == "Macro" and phase >= 1 and not na(tr_high)var box tr_box = nabarcolor(color_candles ? (close > ema21 ? color.new(color.green, 70) : color.new(color.red, 70)) : na)bgcolor(show_bg ? bg_c : na, "Phase Background")bg_c = phase == 2 ? color.new(color.green, 85) : phase == 3 ? color.new(color.red, 85) : phase == 1 ? color.new(color.gray, 90) : na// --- Visualization ---            line.new(bar_index, tp1, bar_index+50, tp1, color=color.green, style=line.style_dashed), label.new(bar_index+50, tp1, "TP1", style=label.style_label_right, textcolor=color.green)            line.new(bar_index, sl, bar_index+50, sl, color=color.red, style=line.style_dashed), label.new(bar_index+50, sl, "SL", style=label.style_label_right, textcolor=color.red)            tp1 = close - atr_val * tp1_atr_mult            sl = high + atr_val * sl_atr_mult        if show_risk_levels:        last_sell_bar := bar_index        label.new(bar_index, high, "SELL", style=label.style_label_down, color=color.new(color.red,20), textcolor=color.white, size=size.normal)    if sell_context and is_in_bear_poi and is_no_demand and momentum_ok_bear and bar_index > last_sell_bar + entry_throttle:    sell_context = phase == 3 and not na(last_ut_bar) and (bar_index - last_ut_bar < 50) and htf_is_bear    momentum_ok_bear = not use_momentum_filter or close < ema21            line.new(bar_index, tp1, bar_index+50, tp1, color=color.green, style=line.style_dashed), label.new(bar_index+50, tp1, "TP1", style=label.style_label_right, textcolor=color.green)            line.new(bar_index, sl, bar_index+50, sl, color=color.red, style=line.style_dashed), label.new(bar_index+50, sl, "SL", style=label.style_label_right, textcolor=color.red)            tp1 = close + atr_val * tp1_atr_mult            sl = low - atr_val * sl_atr_mult        if show_risk_levels:        last_buy_bar := bar_index        label.new(bar_index, low, "BUY", style=label.style_label_up, color=color.new(color.lime,20), textcolor=color.white, size=size.normal)    if buy_context and is_in_bull_poi and is_no_supply and momentum_ok_bull and bar_index > last_buy_bar + entry_throttle:    buy_context = phase == 2 and not na(last_spring_bar) and (bar_index - last_spring_bar < 50) and htf_is_bull    momentum_ok_bull = not use_momentum_filter or close > ema21    ema21 = ta.ema(close, 21)                    else: is_in_bear_poi := true                if array.get(box_is_bull_array, i): is_in_bull_poi := true            if box.get_bottom(bx) < high and box.get_top(bx) > low:            bx = array.get(box_array, i)        for i = array.size(box_array) - 1 to 0:    if array.size(box_array) > 0:    is_in_bull_poi = false, is_in_bear_poi = falseif show_entries:if is_no_demand: label.new(bar_index, high + atr_val*0.2, "ND", style=label.style_none, textcolor=color.red, size=size.tiny)if is_no_supply: label.new(bar_index, low - atr_val*0.2, "NS", style=label.style_none, textcolor=color.green, size=size.tiny)is_no_demand = show_traps and bar_index > 1 and close > open and volume < volume[1] and volume < volume[2]is_no_supply = show_traps and bar_index > 1 and close < open and volume < volume[1] and volume < volume[2]var last_buy_bar = 0, var last_sell_bar = 0htf_is_bear = request.security(syminfo.tickerid, htf_confirm_tf, close < ta.ema(close, 50))htf_is_bull = request.security(syminfo.tickerid, htf_confirm_tf, close > ta.ema(close, 50))// --- Traps & Entry Signals ---        phase := 3, last_event_bar := bar_index, last_ut_bar := bar_index
        f_add_label(bar_index, high, "UT", label.style_label_down, color.new(color.red, 20), color.red)s ---
    // SOS/SOWfo.tickerid, htf_confirm_tf, close > ta.ema(close, 50))
    is_sos = close > tr_high and close > open and volume > vol_sma * 1.5
    is_sow = close < tr_low  and close < open and volume > vol_sma * 1.5
    if is_sos and phase < 3var last_sell_bar = 0
        strong_low := range_lowestr_index > 1 and close < open and volume < volume[1] and volume < volume[2]
        f_add_label(bar_index, high, "SOS", label.style_label_up, color.new(color.blue, 20), color.blue)index > 1 and close > open and volume < volume[1] and volume < volume[2]
        phase := 0, tr_high := na, tr_low := na, last_spring_bar := na, last_ut_bar := na, last_sos_bar := na, last_sow_bar := na, last_bear_off := na, last_bull_off := na
        f_add_label(bar_index, low, "NS", label.style_label_down, color.new(color.green, 20), color.green)
    if is_sow and phase < 2l*0.2, "ND", style=label.style_none, textcolor=color.red, size=size.tiny)
        strong_high := range_highest
        f_add_label(bar_index, low, "SOW", label.style_label_down, color.new(color.purple, 20), color.purple)
        phase := 0, tr_high := na, tr_low := na, last_spring_bar := na, last_ut_bar := na, last_sos_bar := na, last_sow_bar := na

// --- POI (KV/OB) (WSH gá»‘c) ---(box_array) > 0:
if show_kv_zones and bars_ready(1)
    kv_low_prev  = ta.lowest(low, kv_zone_len)[1]            bx = array.get(box_array, i)
    kv_high_prev = ta.highest(high, kv_zone_len)[1]ox.get_bottom(bx) < high and box.get_top(bx) > low:
    is_kv_bull = ta.crossunder(low, kv_low_prev) and close > open and (math.min(open, close) - low) / math.max(math.abs(open - close), syminfo.mintick) >= kv_wick_multox_is_bull_array, i)
    if is_kv_bull_poi := true
        f_draw_poi_box(high[1], low[1], color.blue, line.style_dashed, "KV Bull")
    is_kv_bear = ta.crossover(high, kv_high_prev) and close < open and (high - math.max(open, close)) / math.max(math.abs(open - close), syminfo.mintick) >= kv_wick_mult
    if is_kv_bear
        f_draw_poi_box(high[1], low[1], color.orange, line.style_dashed, "KV Bear")
momentum_filter or close > ema21
if show_ob_zonesast_spring_bar) and (bar_index - last_spring_bar < 50) and htf_is_bull
    var int last_bear_off = naand bar_index > last_buy_bar + entry_throttle:
    var int last_bull_off = nae=label.style_label_up, color=color.new(color.lime,20), textcolor=color.white, size=size.normal)
    if not na(last_sos_bar)ar_index
        bars_since_sos = bar_index - last_sos_bar
        last_bear_off := na
        for i = 1 to math.min(20, bar_index)
            off = bars_since_sos + idex, sl, bar_index+50, sl, color=color.red, style=line.style_dashed)
            if off <= bar_indexle=label.style_label_right, textcolor=color.red)
                if close[off] < open[off]ex+50, tp1, color=color.green, style=line.style_dashed)
                    last_bear_off := na(last_bear_off) ? off : last_bear_offp1, "TP1", style=label.style_label_right, textcolor=color.green)
                else if not na(last_bear_off)
                    breakter or close < ema21
        if not na(last_bear_off)t_bar < 50) and htf_is_bear
            f_draw_poi_box(high[last_bear_off], low[last_bear_off], color.teal, line.style_solid, "OB Bull")_no_demand and momentum_ok_bear and bar_index > last_sell_bar + entry_throttle:
            last_sos_bar := naex, high, "SELL", style=label.style_label_down, color=color.new(color.red,20), textcolor=color.white, size=size.normal)
            last_bear_off := naex
    if not na(last_sow_bar)
        bars_since_sow = bar_index - last_sow_bar
        last_bull_off := na            tp1 = close - atr_val * tp1_atr_mult
        for i = 1 to math.min(20, bar_index)dex+50, sl, color=color.red, style=line.style_dashed)
            off2 = bars_since_sow + ile=label.style_label_right, textcolor=color.red)
sweepLow  = useSweep and not na(lastPL) and low  < lastPL  and close > lastPL  and lowerWickRatio >= sweepWickKatrPct   = atr_val / math.max(nz(close,1.0), 1e-6) * 100.02 <= bar_index0, tp1, color=color.green, style=line.style_dashed)
a.adx(14)TP1", style=label.style_label_right, textcolor=color.green)
// Volume Delta (tick-proxy)
spreadSafe = math.max(spread, 1e-6)
upFrac   = clamp((close - low) / spreadSafe,  0.0, 1.0)
downFrac = clamp((high  - close) / spreadSafe, 0.0, 1.0)TRpct and (not useADX or adx14 >= minADX))new(bar_index[i], high[i], bar_index, high, color=color.new(color.yellow, 50), style=line.style_dotted, width=1)not na(last_bull_off)")
buyVol   = useDelta ? volume * upFrac   : nasessOK() =>off], low[last_bull_off], color.purple, line.style_solid, "OB Bear")
sellVol  = useDelta ? volume * downFrac : na============================================================last_sow_bar := na
volDelta = useDelta ? (buyVol - sellVol) : naNGINES â€” Sweep / Delta / MicroBOS / Gate / Score    last_bull_off := nabarcolor(candle_color)
zDelta   = useDelta ? (volDelta - ta.sma(volDelta, deltaLen)) / math.max(ta.stdev(volDelta, deltaLen), 1e-6) : na
deltaPos = useDelta and (nz(zDelta, 0.0) > 0)label.style_label_down, color=is_strong_h ? color.new(color.maroon, 20) : color.new(color.red, 20), textcolor=color.white, size=size.tiny)r_high):
hhMicro = ta.highest(high, lk_micro)[1]OSnd (nz(zDelta, 0.0) < 0)
llMicro = ta.lowest(low,  lk_micro)[1] useSweep and not na(lastPH) and high > lastPH and close < lastPH and upperWickRatio >= sweepWickKor.green, 20), textcolor=color.white, size=size.tiny)low,  pivot_len, pivot_len)(tr_start_bar, tr_high, bar_index, tr_low, border_color=color.new(color.gray, 50), bgcolor=na)
microUp = useMicroBOS and close > hhMicroe-6)
microDown = useMicroBOS and close < llMicro)
strong_high) < atr_val * 0.1        box.set_top(tr_box, tr_high)
// Top-down Gate (MA50 bias)1 to 50        box.set_bottom(tr_box, tr_low)
f_bias(tf) =>index)
    c  = request.security(syminfo.tickerid, tf, close,             barmerge.gaps_off, barmerge.lookahead_off)f math.abs(high[i] - high) < atr_val * liquidity_atr_mult
    ma = request.security(syminfo.tickerid, tf, ta.sma(close, 50), barmerge.gaps_off, barmerge.lookahead_off)
    c > ma ? 1.0 : c < ma ? -1.0 : 0.0
float gateScore = 0.0if useGate    if useD        gateScore += wD   * f_bias("D")    if use4H        gateScore += w4H  * f_bias("240")    if use1H        gateScore += w1H  * f_bias("60")    if use30m        gateScore += w30  * f_bias("30")canLongGate  = not useGate or gateScore >=  gateLongThrcanShortGate = not useGate or gateScore <= -gateShortThr// =============================================================================// IV. ENTRY (giá»¯ logic WSH, thÃªm confluence cho scalper)// =============================================================================var int last_buy_bar = 0var int last_sell_bar = 0enough_vol_hist = bars_ready(2)is_no_supply = show_traps and enough_vol_hist and close < open and volume < volume[1] and volume < volume[2]is_no_demand = show_traps and enough_vol_hist and close > open and volume < volume[1] and volume < volume[2]// In-POI check (scan newest â†’ oldest)in_bull_poi = falsein_bear_poi = falseif array.size(box_array) > 0    for i = array.size(box_array) - 1 to 0        bx = array.get(box_array, i)        if box.get_bottom(bx) < high and box.get_top(bx) > low            if array.get(box_is_bull, i)                in_bull_poi := true            else                in_bear_poi := true// Momentum & Wyckoff context (WSH gá»‘c)momentum_bull = close > ema21momentum_bear = close < ema21buy_context  = phase == 2 and not na(last_spring_bar) and (bar_index - last_spring_bar < 25) and htf_is_bullsell_context = phase == 3 and not na(last_ut_bar)      and (bar_index - last_ut_bar   < 25) and htf_is_bear// Confluence score (nháº¹)float longScore = 0.0float shortScore = 0.0if useScore    longScore  += (in_bull_poi   ? w_inPOI    : 0)    longScore  += (is_no_supply  ? w_NSND     : 0)    longScore  += (momentum_bull ? w_momentum : 0)    longScore  += (sweepLow      ? w_sweep    : 0)    longScore  += (deltaPos      ? w_delta    : 0)    longScore  += (microUp       ? w_micro    : 0)    longScore  += (canLongGate   ? w_gate     : 0)    shortScore += (in_bear_poi   ? w_inPOI    : 0)    shortScore += (is_no_demand  ? w_NSND     : 0)    shortScore += (momentum_bear ? w_momentum : 0)    shortScore += (sweepHigh     ? w_sweep    : 0)    shortScore += (deltaNeg      ? w_delta    : 0)    shortScore += (microDown     ? w_micro    : 0)    shortScore += (canShortGate  ? w_gate     : 0)// Final entry gates (scalper: nhanh, rÃµ)canBuy  = show_entries and buy_context  and (not useScore or longScore  >= longThr) and regimeOK and sessOK() and bar_index > last_buy_bar  + entry_throttlecanSell = show_entries and sell_context and (not useScore or shortScore >= shortThr) and regimeOK and sessOK() and bar_index > last_sell_bar + entry_throttle// Plot & SL/TPif canBuy    label.new(bar_index, low, "BUY" + (useScore ? " S="+str.tostring(longScore, format.mintick) : ""), style=label.style_label_up, color=color.new(color.lime, 20), textcolor=color.white, size=size.normal)    if show_risk_levels        sl = low - atr_val * sl_atr_mult        tp1 = close + atr_val * tp1_atr_mult        tp2 = close + atr_val * tp2_atr_mult        line.new(bar_index, sl,  bar_index + 50, sl,  color=color.red,   style=line.style_dashed)        label.new(bar_index + 50, sl,  "SL",  style=label.style_label_right, textcolor=color.red,   color=color.new(color.gray, 100))        line.new(bar_index, tp1, bar_index + 50, tp1, color=color.green, style=line.style_dashed)        label.new(bar_index + 50, tp1, "TP1", style=label.style_label_right, textcolor=color.green, color=color.new(color.gray, 100))    last_buy_bar := bar_indexif canSell    label.new(bar_index, high, "SELL" + (useScore ? " S="+str.tostring(shortScore, format.mintick) : ""), style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.normal)    if show_risk_levels        sl = high + atr_val * sl_atr_mult        tp1 = close - atr_val * tp1_atr_mult        line.new(bar_index, sl,  bar_index + 50, sl,  color=color.red,   style=line.style_dashed)        label.new(bar_index + 50, sl,  "SL",  style=label.style_label_right, textcolor=color.red,   color=color.new(color.gray, 100))        line.new(bar_index, tp1, bar_index + 50, tp1, color=color.green, style=line.style_dashed)        label.new(bar_index + 50, tp1, "TP1", style=label.style_label_right, textcolor=color.green, color=color.new(color.gray, 100))    last_sell_bar := bar_index// =============================================================================// V. Visualization (WSH gá»‘c)// =============================================================================bg_c = phase == 2 ? color.new(color.green, 85) : phase == 3 ? color.new(color.red, 85) : phase == 1 ? color.new(color.gray, 90) : nabgcolor(show_bg ? bg_c : na)var box tr_box = naif phase >= 1 and not na(tr_high)    if na(tr_box)        tr_box := box.new(tr_start_bar, tr_high, bar_index, tr_low, border_color=color.new(color.gray, 50), bgcolor=na)    else
        box.set_left(tr_box, tr_start_bar)
        box.set_top(tr_box, tr_high)
        box.set_bottom(tr_box, tr_low)
        box.set_right(tr_box, bar_index)
else
    if not na(tr_box)
        box.delete(tr_box)
        tr_box := na

// =============================================================================
 // VI. Alerts
// =============================================================================
enableAlerts = input.bool(true, "Enable Alerts", group="0. General Settings")
if enableAlerts
    alertcondition(canBuy,  "WSH BUY (Scalper)",  "WSH v5.1: BUY setup (scalper).")
    alertcondition(canSell, "WSH SELL (Scalper)", "WSH v5.1: SELL setup (scalper).")