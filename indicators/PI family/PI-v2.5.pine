// Â© 2025 Gemini AI - PI v2.1 Fixed (No LinePool System)
// @version=5
indicator("PI v2.5", shorttitle="PI v2.5", overlay=true, max_labels_count=500)

// === GREG'S WAY (GW) - PHáº¦N 0: KHAI BÃO & Cáº¤U HÃŒNH Cá»T LÃ•I ===
var float VALUE_AREA_PERCENT = 0.7
var float CLIMAX_VOL_THRESHOLD = 0.95
var float DEFAULT_CLOSE_LOCATION = 0.5
var float MIN_PRICE_RANGE = 0.00001
var int VA_UPDATE_INTERVAL = 10
var float VA_PRICE_MOVE_THRESHOLD = 0.03

// Sá»­a khai bÃ¡o type - má»—i field trÃªn má»™t dÃ²ng
type BarAnalysis
    bool isUp
    bool isDown
    bool isNarrow
    bool isWide
    bool isHighVol
    bool isLowVol
    float location

// === PHáº¦N 1: Báº¢NG ÄIá»€U KHIá»‚N & CÃ€I Äáº¶T ===
var string GRP_DISPLAY = "ðŸŽ¨ Giao Dien & Hien Thi"
showInfoPanel = input.bool(false, "Bang Thong Tin", group=GRP_DISPLAY)
dashboardPosition = input.string("top_right", "Vi tri Dashboard", options=["top_left", "top_center", "top_right", "middle_left", "middle_center", "middle_right", "bottom_left", "bottom_center", "bottom_right"], group=GRP_DISPLAY)
showBackground = input.bool(false, "To Nen Tin Hieu Manh", group=GRP_DISPLAY)
showScoreOnBars = input.bool(false, "Hien Thi Diem VSA", group=GRP_DISPLAY)

var string GRP_SCORE_LABEL = "ðŸ“Š TÃ¹y Chá»‰nh NhÃ£n Äiá»ƒm VSA"
scoreLabelOffset = input.float(0.2, "Khoáº£ng cÃ¡ch (x ATR)", group=GRP_SCORE_LABEL, minval=0, step=0.05)
scoreLabelBullColor = input.color(color.new(color.green, 25), "MÃ u Ä‘iá»ƒm TÄƒng", group=GRP_SCORE_LABEL)
scoreLabelBearColor = input.color(color.new(color.red, 25), "MÃ u Ä‘iá»ƒm Giáº£m", group=GRP_SCORE_LABEL)

var string GRP_VP = "ðŸ“Š Value Area"
showVALines = input.bool(true, "Hien thi POC, VAH, VAL", group=GRP_VP)
vpLookback = input.int(50, "Do dai tinh VA", group=GRP_VP, minval=20, maxval=200)
vpProximityPercent = input.float(0.3, "Bien do Tim kiem quanh VA (%)", group=GRP_VP, minval=0.1, maxval=2.0, step=0.1)

var string GRP_TR_LINES = "ðŸ“ˆ Duong Trading Range"
showTRLines = input.bool(true, "Ve Duong S/R tu dong", group=GRP_TR_LINES)
trLineOffset = input.int(20, "Do dai ke duong", group=GRP_TR_LINES, minval=5, maxval=50)

var string GRP_SIGNALS = "ðŸŽ¯ Cau Hinh Tin Hieu"
enableSpringUpthrust = input.bool(true, "Spring & Upthrust", group=GRP_SIGNALS)
enableClimacticVol = input.bool(true, "Volume Cuc Dai (Climax)", group=GRP_SIGNALS)
enableNoSupplyDemand = input.bool(true, "No Supply & No Demand", group=GRP_SIGNALS)
enableStoppingVol = input.bool(true, "Stopping Volume", group=GRP_SIGNALS)
enableEffortVsResult = input.bool(true, "No Luc vs Ket Qua", group=GRP_SIGNALS)
enableShakeout = input.bool(true, "Shakeout", group=GRP_SIGNALS)
enableSOS_SOW = input.bool(true, "Sign of Strength/Weakness", group=GRP_SIGNALS)
enableTestBar = input.bool(true, "Test Bar", group=GRP_SIGNALS)

var string GRP_PARAMS = "âš™ï¸ Tham So Chien Luoc"
lookbackH_L = input.int(12, "Do dai tim H/L (Spring/UT)", group=GRP_PARAMS, minval=5, maxval=100)
volLookback = input.int(20, "Do dai tinh Volume TB", group=GRP_PARAMS)
volMultiplier = input.float(1.8, "He so Volume Cao", group=GRP_PARAMS, step=0.1)
lowVolMultiplier = input.float(0.6, "He so Volume Thap", group=GRP_PARAMS, step=0.1)
climaxLookback = input.int(40, "Do dai tim Volume Climax", group=GRP_PARAMS)
scoreLookback = input.int(10, "Do dai tinh Diem VSA", group=GRP_PARAMS)
narrowRangeFactor = input.float(0.7, "He so Nen Hep (Narrow)", group=GRP_PARAMS)
wideRangeFactor = input.float(1.3, "He so Nen Rong (Wide)", group=GRP_PARAMS)
bullishCloseLocation = input.float(0.6, "Nguong Dong cua Bullish", group=GRP_PARAMS, step=0.1)
bearishCloseLocation = input.float(0.4, "Nguong Dong cua Bearish", group=GRP_PARAMS, step=0.1)

var string GRP_TREND = "ðŸŒŠ He Thong Dan Duong"
useDualEMA = input.bool(true, "Su dung He thong EMA Kep", group=GRP_TREND)
emaFastLength = input.int(21, "EMA Nhanh", group=GRP_TREND)
emaFastColor = input.color(color.aqua, "MÃ u", group=GRP_TREND)
emaSlowLength = input.int(50, "EMA Cham", group=GRP_TREND)
emaSlowColor = input.color(color.orange, "MÃ u", group=GRP_TREND)
showEmaCloud = input.bool(true, "Hien thi Dam may Xu huong", group=GRP_TREND)
useEma200 = input.bool(true, "Su dung EMA 200 (Boi canh)", group=GRP_TREND)
emaLength200 = input.int(200, "EMA 200", group=GRP_TREND)
ema200Color = input.color(color.gray, "MÃ u", group=GRP_TREND)

// === PHáº¦N 2: KHá»žI Táº O & HÃ€M TIá»†N ÃCH ===
var float cached_dPOC = na
var float cached_dVAH = na
var float cached_dVAL = na
var int last_va_bar = 0
var bool va_cache_valid = false

f_safeDivision(n, d) => d > MIN_PRICE_RANGE ? n / d : na

// Sá»­a hÃ m f_safeSum - cÃº phÃ¡p vÃ²ng láº·p for
f_safeSum(source, length) =>
    _sum = 0.0
    lookback_len = math.min(length - 1, bar_index)
    if lookback_len >= 0
        for i = 0 to lookback_len
            _sum += nz(source[i])
    _sum

f_analyzeBar() =>
    _range = high - low
    _avgVolume = ta.sma(volume, volLookback)
    _isNarrow = _range < ta.sma(_range, volLookback) * narrowRangeFactor
    _isWide = _range > ta.sma(_range, volLookback) * wideRangeFactor
    _isHighVol = volume > _avgVolume * volMultiplier
    _isLowVol = volume < _avgVolume * lowVolMultiplier
    _location = f_safeDivision(close - low, _range)
    BarAnalysis.new(close > open, close < open, _isNarrow, _isWide, _isHighVol, _isLowVol, nz(_location, 0.5))

f_isNearVA(price) =>
    if not va_cache_valid or na(cached_dPOC)
        false
    else
        pocDiff = f_safeDivision(math.abs(price - cached_dPOC), cached_dPOC)
        vahDiff = f_safeDivision(math.abs(price - cached_dVAH), cached_dVAH)
        valDiff = f_safeDivision(math.abs(price - cached_dVAL), cached_dVAL)
        (not na(pocDiff) and pocDiff < vpProximityPercent / 100) or (not na(vahDiff) and vahDiff < vpProximityPercent / 100) or (not na(valDiff) and valDiff < vpProximityPercent / 100)

f_calculateValueArea() =>
    // TÄƒng sá»‘ lÆ°á»£ng rows Ä‘á»ƒ tÃ­nh toÃ¡n chÃ­nh xÃ¡c hÆ¡n
    rowCount = 200
    lookback_high = ta.highest(high, vpLookback)
    lookback_low = ta.lowest(low, vpLookback)
    step_price = f_safeDivision(lookback_high - lookback_low, rowCount - 1)
    
    if na(step_price) or step_price <= MIN_PRICE_RANGE
        [close, lookback_high, lookback_low]
    else
        price_rows = array.new<float>(rowCount, 0)
        volume_rows = array.new<float>(rowCount, 0)
        array.fill(volume_rows, 0)
        
        // Khá»Ÿi táº¡o price levels
        for i = 0 to rowCount - 1
            array.set(price_rows, i, lookback_low + step_price * i)
        
        // PhÃ¢n phá»‘i volume theo tá»«ng bar
        total_volume = 0.0
        for i = 0 to math.min(vpLookback - 1, bar_index)
            bar_high = high[i]
            bar_low = low[i]
            bar_vol = nz(volume[i])
            total_volume += bar_vol
            
            // PhÃ¢n chia volume theo range cá»§a bar
            start_index = math.max(0, math.round(f_safeDivision(bar_low - lookback_low, step_price)))
            end_index = math.min(rowCount - 1, math.round(f_safeDivision(bar_high - lookback_low, step_price)))
            
            if start_index <= end_index
                rows_in_bar = end_index - start_index + 1
                vol_per_row = bar_vol / rows_in_bar
                
                for j = start_index to end_index
                    current_vol = array.get(volume_rows, j)
                    array.set(volume_rows, j, current_vol + vol_per_row)
        
        // TÃ¬m POC
        poc_volume = array.max(volume_rows)
        poc_index = na(poc_volume) ? na : array.indexof(volume_rows, poc_volume)
        _dPOC = na(poc_index) ? close : array.get(price_rows, poc_index)
        
        // TÃ­nh Value Area (70% volume)
        va_volume_target = total_volume * VALUE_AREA_PERCENT
        va_volume_current = nz(poc_volume)
        up_index = nz(poc_index, 0) + 1
        down_index = nz(poc_index, 0) - 1
        
        // Má»Ÿ rá»™ng Value Area tá»« POC
        while va_volume_current < va_volume_target and (up_index < rowCount or down_index >= 0)
            vol_up = up_index < rowCount ? array.get(volume_rows, up_index) : 0
            vol_down = down_index >= 0 ? array.get(volume_rows, down_index) : 0
            
            if vol_up == 0 and vol_down == 0
                break
                
            // Chá»n phÃ­a cÃ³ volume cao hÆ¡n
            if vol_up >= vol_down and up_index < rowCount
                va_volume_current += vol_up
                up_index += 1
            else if down_index >= 0
                va_volume_current += vol_down
                down_index -= 1
            else
                up_index += 1
        
        // TÃ­nh VAH vÃ  VAL
        _dVAH = up_index > nz(poc_index, 0) ? array.get(price_rows, math.min(rowCount - 1, up_index - 1)) : _dPOC
        _dVAL = down_index < nz(poc_index, 0) ? array.get(price_rows, math.max(0, down_index + 1)) : _dPOC
        
        // Äáº£m báº£o VAH > POC > VAL
        if _dVAH < _dPOC
            _dVAH := _dPOC + (step_price * 5)
        if _dVAL > _dPOC
            _dVAL := _dPOC - (step_price * 5)
        
        [_dPOC, _dVAH, _dVAL]

// === PHáº¦N 3: VÃ’NG Láº¶P TÃNH TOÃN CHÃNH ===
bar = f_analyzeBar()
fastEMA = ta.ema(close, emaFastLength)
slowEMA = ta.ema(close, emaSlowLength)
ema200 = ta.ema(close, emaLength200)
isUptrend = useDualEMA ? fastEMA > slowEMA : close > ema200

lowest_low_val = ta.lowest(low, lookbackH_L)[1]
highest_high_val = ta.highest(high, lookbackH_L)[1]
highest_vol_val = ta.highest(volume, climaxLookback)

atr14 = ta.atr(14)

// Update VA má»—i bar Ä‘á»ƒ Ä‘áº£m báº£o luÃ´n cÃ³ data
[newPOC, newVAH, newVAL] = f_calculateValueArea()
if not na(newPOC)
    cached_dPOC := newPOC
    cached_dVAH := newVAH
    cached_dVAL := newVAL
    va_cache_valid := true
    last_va_bar := bar_index

float barScore = 0.0

// Sá»­a khá»Ÿi táº¡o array
var bullish_signals_on_bar = array.new<string>()
var bearish_signals_on_bar = array.new<string>()

array.clear(bullish_signals_on_bar)
array.clear(bearish_signals_on_bar)

// VSA SIGNAL DETECTION
isSpring = false
isUpthrust = false

if barstate.isconfirmed
    // Sá»­a Ä‘iá»u kiá»‡n SOS/SOW vá»›i kiá»ƒm tra na
    isSpring := enableSpringUpthrust and bar.isDown and close > lowest_low_val and low < lowest_low_val and bar.isHighVol
    isSellingClimax = enableClimacticVol and bar.isDown and bar.isWide and volume >= highest_vol_val * CLIMAX_VOL_THRESHOLD
    isStoppingVol = enableStoppingVol and bar.isDown and bar.isHighVol and bar.location > bullishCloseLocation
    isEffortVsFall = enableEffortVsResult and bar.isDown and bar.isHighVol and bar.isNarrow
    isShakeout = enableShakeout and bar.isDown and bar.isHighVol and bar.location > bullishCloseLocation
    
    // Sá»­a SOS vá»›i kiá»ƒm tra VA há»£p lá»‡
    isSOS = enableSOS_SOW and bar.isUp and bar.isHighVol and bar.location > 0.7 and (va_cache_valid and not na(cached_dVAH) and not na(cached_dPOC) ? (close > cached_dVAH or close > cached_dPOC) : true)
    
    isTestBar = enableTestBar and bar.isDown and bar.isNarrow and bar.isLowVol and bar.location > bullishCloseLocation
    isNoSupply = enableNoSupplyDemand and bar.isDown and bar.isNarrow and bar.isLowVol
    isUpthrust := enableSpringUpthrust and bar.isUp and close < highest_high_val and high > highest_high_val and bar.isHighVol
    isBuyingClimax = enableClimacticVol and bar.isUp and bar.isWide and volume >= highest_vol_val * CLIMAX_VOL_THRESHOLD
    isEffortVsRise = enableEffortVsResult and bar.isUp and bar.isHighVol and bar.isNarrow
    
    // Sá»­a SOW vá»›i kiá»ƒm tra VA há»£p lá»‡
    isSOW = enableSOS_SOW and bar.isDown and bar.isHighVol and bar.location < bearishCloseLocation and (va_cache_valid and not na(cached_dVAL) and not na(cached_dPOC) ? (close < cached_dVAL or close < cached_dPOC) : true)
    
    isNoDemand = enableNoSupplyDemand and bar.isUp and bar.isNarrow and bar.isLowVol

    if isSpring
        array.push(bullish_signals_on_bar, "ðŸ”º")
        barScore += 2.5
    if isSellingClimax
        array.push(bullish_signals_on_bar, "ðŸ”´")
        barScore += 2.0
    if isStoppingVol
        array.push(bullish_signals_on_bar, "â¹ï¸")
        barScore += 2.2
    if isEffortVsFall
        array.push(bullish_signals_on_bar, "â†—ï¸")
        barScore += 2.0
    if isShakeout
        array.push(bullish_signals_on_bar, "âš ï¸")
        barScore += 2.2
    if isSOS
        array.push(bullish_signals_on_bar, "ðŸ“ˆ")
        barScore += 2.4
    if isTestBar
        array.push(bullish_signals_on_bar, "â†”ï¸")
        barScore += 1.5
    if isNoSupply
        array.push(bullish_signals_on_bar, "ðŸ”¸")
        barScore += 1.0
    if isUpthrust
        array.push(bearish_signals_on_bar, "ðŸ”»")
        barScore -= 2.5
    if isBuyingClimax
        array.push(bearish_signals_on_bar, "ðŸŸ¢")
        barScore -= 2.0
    if isEffortVsRise
        array.push(bearish_signals_on_bar, "â†˜ï¸")
        barScore -= 2.0
    if isSOW
        array.push(bearish_signals_on_bar, "ðŸ“‰")
        barScore -= 2.4
    if isNoDemand
        array.push(bearish_signals_on_bar, "ðŸ”¹")
        barScore -= 1.0

vsaScore = f_safeSum(barScore, scoreLookback)

// === PHáº¦N 4: HIá»‚N THá»Š & GIAO DIá»†N NGÆ¯á»œI DÃ™NG ===
p_ema200 = plot(useEma200 ? ema200 : na, "EMA 200", ema200Color, 1)
p_fast = plot(useDualEMA ? fastEMA : na, "EMA Nhanh", emaFastColor, 1)
p_slow = plot(useDualEMA ? slowEMA : na, "EMA Cham", emaSlowColor, 1)

fill(p_fast, p_slow, color=useDualEMA and showEmaCloud ? (fastEMA > slowEMA ? color.new(color.green, 85) : color.new(color.red, 85)) : na)

// === Váº¼ VALUE AREA Báº°NG PLOT (DÃNH Vá»šI Náº¾N) ===
// Hiá»ƒn thá»‹ luÃ´n khÃ´ng cáº§n kiá»ƒm tra va_cache_valid
plot(showVALines ? cached_dPOC : na, "POC", color.red, 1, plot.style_line)
plot(showVALines ? cached_dVAH : na, "VAH", color.blue, 1, plot.style_line)
plot(showVALines ? cached_dVAL : na, "VAL", color.blue, 1, plot.style_line)

bgcolor(showBackground and math.abs(vsaScore) > 2.5 ? (vsaScore > 0 ? color.new(color.green, 40) : color.new(color.red, 40)) : na)

// === TRADING RANGE MARKS (KHÃ”NG DÃ™NG LinePool) ===
plotchar(showTRLines and isSpring, "Spring", "â–²", location.belowbar, color.green, size=size.tiny)
plotchar(showTRLines and isUpthrust, "Upthrust", "â–¼", location.abovebar, color.red, size=size.tiny)

// === SIGNAL LABELS ===
if array.size(bullish_signals_on_bar) > 0
    bullish_text = array.join(bullish_signals_on_bar, "+")
    
    // Chá»‰ thÃªm star cho Selling Climax (SC)
    shouldShowStar = false
    for i = 0 to array.size(bullish_signals_on_bar) - 1
        signal = array.get(bullish_signals_on_bar, i)
        if signal == "SC"
            shouldShowStar := true
            break
    
    finalBullText = shouldShowStar ? bullish_text + "â­" : bullish_text
    // PI: Äáº·t xa hÆ¡n Ä‘á»ƒ trÃ¡nh Ä‘Ã¨ vá»›i PICE (offset 2.5x ATR)
    labelPrice = low - (atr14 * 0.5)
    label.new(bar_index, labelPrice, finalBullText, style=label.style_none, yloc=yloc.price, 
              color=color.new(color.gray, 30), textcolor=color.black, size=size.normal)  // Äá»”I white â†’ gray

if array.size(bearish_signals_on_bar) > 0
    bearish_text = array.join(bearish_signals_on_bar, "+")
    
    // Chá»‰ thÃªm star cho Buying Climax (BC)
