//@version=6
// TITLE: CVD Pro - Sniper Edition
// DESC: CVD + VSA + 7-Level Alert System cho crypto trading. Optimize cho 1H-4H timeframe.
//       Philosophy: "Chuáº©n bá»‹ nhÆ° báº¯n voi, timing nhÆ° báº¯n ruá»“i"
// Author: Khogao, 2025
// Based on: CVPZero advanced alert system

indicator("CVD Pro Sniper", "CVPS", overlay=false)
import TradingView/ta/8

// === NHOM 1: CVD ENGINE ===
const string GRP_CVD = "âš™ï¸ CVD Engine"
anchorInput = input.timeframe("D", "Chu ká»³ reset CVD", group = GRP_CVD, tooltip = "Khung thá»i gian mÃ  CVD reset (tÃ­nh láº¡i). 'D' (ngÃ y) Ä‘Æ°á»£c khuyáº¿n nghá»‹ cho intraday crypto.")
useCustomTimeframeInput = input.bool(false, "DÃ¹ng khung thá»i gian tÃ¹y chá»‰nh", group = GRP_CVD, tooltip = "Ghi Ä‘Ã¨ lá»±a chá»n tá»± Ä‘á»™ng khung thá»i gian tháº¥p hÆ¡n. DÃ¹ng tháº­n trá»ng vá»›i crypto volatility.")
lowerTimeframeInput = input.timeframe("1", "Khung thá»i gian tháº¥p hÆ¡n", group = GRP_CVD)

// === NHOM 2: MA & BOLLINGER BANDS ===
const string GRP_MA_BB = "ğŸ“Š MA & Bollinger Bands"
maTypeInput = input.string("SMA", "Loáº¡i MA", options=["SMA", "EMA", "WMA", "VWMA"], group = GRP_MA_BB)
maLengthInput = input.int(20, "Äá»™ dÃ i MA", group = GRP_MA_BB, tooltip="20 periods recommended cho crypto 1H-4H")
bbMultInput = input.float(2.0, "BB StdDev", minval=0.001, maxval=50, group = GRP_MA_BB)
showBollingerBands = input.bool(true, "Hiá»ƒn thá»‹ Bollinger Bands", group = GRP_MA_BB, tooltip="BB trÃªn CVD nhÆ° má»©c quÃ¡ mua/bÃ¡n Ä‘á»™ng. Critical cho Cáº¤P 3 & 6 alerts.")

// === NHOM 3: DIVERGENCE ENGINE ===
const string GRP_DIVERGENCE = "ğŸ“Š PhÃ¢n Ká»³ (Divergence)"
// CVD+Price Divergence
showRegular = input.bool(true, "C+P: PhÃ¢n ká»³ thÆ°á»ng", group = GRP_DIVERGENCE)
showHidden = input.bool(true, "C+P: PhÃ¢n ká»³ áº©n", group = GRP_DIVERGENCE)
// CVD+Volume Divergence
showCvdVolRegular = input.bool(true, "C+V: PhÃ¢n ká»³ thÆ°á»ng", group = GRP_DIVERGENCE)
showCvdVolHidden = input.bool(true, "C+V: PhÃ¢n ká»³ áº©n", group = GRP_DIVERGENCE)
// Pivot Settings
lookbackLeft = input.int(5, "Pivot: Lookback trÃ¡i", group = GRP_DIVERGENCE)
lookbackRight = input.int(5, "Pivot: Lookback pháº£i", group = GRP_DIVERGENCE)
rangeLower = input.int(5, "Pivot: Range min", group = GRP_DIVERGENCE)
rangeUpper = input.int(60, "Pivot: Range max", group = GRP_DIVERGENCE)

// === NHOM 4: VSA SIGNALS ===
const string GRP_VSA = "ğŸ’¡ VSA Signals"
showVSASignals = input.bool(true, "Hiá»ƒn thá»‹ tÃ­n hiá»‡u VSA", group=GRP_VSA, tooltip="16 tÃ­n hiá»‡u VSA Wyckoff cho crypto")
showSC = input.bool(true, "Selling Climax (SC)", group=GRP_VSA)
showBC = input.bool(true, "Buying Climax (BC)", group=GRP_VSA)
showND = input.bool(true, "No Demand (ND)", group=GRP_VSA)
showNS = input.bool(true, "No Supply (NS)", group=GRP_VSA)
showEF = input.bool(true, "Effort to Fall (EF)", group=GRP_VSA)
showER = input.bool(true, "Effort to Rise (ER)", group=GRP_VSA)
showNE = input.bool(true, "No Effort Down (NE)", group=GRP_VSA)
showNU = input.bool(true, "No Effort Up (NU)", group=GRP_VSA)
showBH = input.bool(true, "Bag Holding (BH)", group=GRP_VSA)
showUT = input.bool(true, "Upthrust (UT)", group=GRP_VSA)
showSP = input.bool(true, "Spring (SP)", group=GRP_VSA)
showTE = input.bool(true, "Test (TE)", group=GRP_VSA)
showSV = input.bool(true, "Stopping Volume (SV)", group=GRP_VSA)
showWK = input.bool(true, "Weakness (WK)", group=GRP_VSA)
showST = input.bool(true, "Strength (ST)", group=GRP_VSA)
showSO = input.bool(true, "Shakeout (SO)", group=GRP_VSA)
showVSALegend = input.bool(true, "Hiá»ƒn thá»‹ chÃº giáº£i VSA (legend)", group=GRP_VSA)
legendPosition = input.string("bottom_right", "Vá»‹ trÃ­ legend", options=["top_left","top_right","bottom_left","bottom_right"], group=GRP_VSA)
vsaVolumeLength = input.int(20, "Äá»™ dÃ i MA Volume cho VSA", minval=5, maxval=100, group=GRP_VSA)
vsaSensitivity = input.float(1.5, "Äá»™ nháº¡y VSA", minval=1.0, maxval=3.0, step=0.1, group=GRP_VSA, tooltip="1.5 recommended cho crypto 1H-4H")
vsaClassifierMethod = input.string("zscore", "Volume classifier method", options=["ratio", "zscore"], group=GRP_VSA, tooltip="Z-score better cho crypto volatility")
vsa_zscore_sensitivity_ltf = input.float(2.5, "VSA Z-score Sensitivity (LTF 1-15m)", minval=0.5, maxval=6.0, step=0.1, group=GRP_VSA)
vsa_zscore_sensitivity_htf = input.float(1.6, "VSA Z-score Sensitivity (HTF 1H+)", minval=0.5, maxval=6.0, step=0.1, group=GRP_VSA)
vsaRequireCvdConfirm = input.bool(false, "YÃªu cáº§u xÃ¡c nháº­n CVD (tÄƒngâ†’CVD>MA, giáº£mâ†’CVD<MA)", group=GRP_VSA, tooltip="Lá»c VSA signal: chá»‰ hiá»‡n khi CVD confirm hÆ°á»›ng. Giáº£m false signal ~30-40%.")

// === NHOM 5: VSA-DIVERGENCE REVERSAL PATTERN ===
const string GRP_VSA_DIV = "ğŸ¯ VSAâ†’Divergence Reversal (Sniper Setup)"
enableVsaDivPattern = input.bool(true, "Enable VSAâ†’Div Reversal Detection", group=GRP_VSA_DIV, tooltip="Pattern: Náº¿n 1 cÃ³ VSA marker â†’ Náº¿n 2 cÃ³ Divergence ngÆ°á»£c láº¡i = Wyckoff Distribution/Accumulation")
showVsaDivMarker = input.bool(true, "Show Diamond Marker", group=GRP_VSA_DIV)
vsaDivAlertEnabled = input.bool(true, "Enable VSAâ†’Div Alert", group=GRP_VSA_DIV)
vsaDivMinTF = input.int(60, "Min Timeframe (minutes)", minval=1, maxval=1440, group=GRP_VSA_DIV, tooltip="Chá»‰ Ã¡p dá»¥ng pattern cho TF >= giÃ¡ trá»‹ nÃ y. 60m (1H) recommended cho crypto sniper")

// === NHOM 6: ALERTS SYSTEM (7 Cáº¤P Äá»˜) ===
const string GRP_ALERTS = "ğŸ”” Cáº£nh BÃ¡o (7 Cáº¥p Äá»™)"
enableBasicDivAlerts = input.bool(true, "Cáº¤P 1: Basic Divergence Alerts", group = GRP_ALERTS, tooltip="Win rate ~50-55%. Nhiá»u signal, cáº§n confirm.")
enableConfluentAlerts = input.bool(true, "Cáº¤P 2: Há»™i Tá»¥ KÃ©p (C+P + C+V)", group = GRP_ALERTS, tooltip="Win rate ~70%. Setup chÃ­nh cho swing trade.")
enableBBBreakAlerts = input.bool(true, "Cáº¤P 3: BB Break (Cáº£m TÃ­n)", group = GRP_ALERTS, tooltip="Win rate ~45-55%. KHÃ”NG vÃ o lá»‡nh ngay, Ä‘á»£i confirm!")
enableVSAConfluentAlerts = input.bool(true, "Cáº¤P 4: VSA + Divergence", group = GRP_ALERTS, tooltip="Win rate ~68%. Setup chÃ­nh.")
enableTripleConfluence = input.bool(true, "Cáº¤P 5: Há»™i Tá»¥ Ba (C+P+C+V+VSA)", group = GRP_ALERTS, tooltip="Win rate ~80%. CHáº®C Ä‚N NHáº¤T! TÄƒng risk lÃªn 2%.")
enableExtremeAlerts = input.bool(true, "Cáº¤P 6: Cá»±c Äoan (BB + Divergence)", group = GRP_ALERTS, tooltip="Win rate ~72%. Reversal zone.")
enableVsaDivRevAlerts = input.bool(true, "Cáº¤P 7: VSAâ†’Div Reversal (Sniper)", group = GRP_ALERTS, tooltip="Win rate ~78%. Pattern máº¡nh nháº¥t cho 1H-4H!")

// === NHOM 7: DISPLAY & COLORS ===
const string GRP_DISPLAY_NEW = "ğŸ¨ Hiá»ƒn Thá»‹ & MÃ u Sáº¯c"
bullColor = input.color(color.green, "C+P Bull Regular", group = GRP_DISPLAY_NEW, inline="cp_bull")
hiddenBullColor = input.color(color.new(color.green, 40), "C+P Bull Hidden", group = GRP_DISPLAY_NEW, inline="cp_bull")
bearColor = input.color(color.red, "C+P Bear Regular", group = GRP_DISPLAY_NEW, inline="cp_bear")
hiddenBearColor = input.color(color.new(color.red, 40), "C+P Bear Hidden", group = GRP_DISPLAY_NEW, inline="cp_bear")
cvdVolBullRegularColor = input.color(color.teal, "C+V Bull Regular", group = GRP_DISPLAY_NEW, inline="cv_bull")
cvdVolBullHiddenColor = input.color(color.new(color.teal, 60), "C+V Bull Hidden", group = GRP_DISPLAY_NEW, inline="cv_bull")
cvdVolBearRegularColor = input.color(color.maroon, "C+V Bear Regular", group = GRP_DISPLAY_NEW, inline="cv_bear")
cvdVolBearHiddenColor = input.color(color.new(color.maroon, 60), "C+V Bear Hidden", group = GRP_DISPLAY_NEW, inline="cv_bear")

// === GROUP: DISPLAY & TABLE (Old) ===
const string GRP_DISPLAY = "Display & Table"
plotStyle = input.string("Line with MA", "Plot Style", options=["Line with MA", "Candles"], group = GRP_DISPLAY)
showCandleColors = input.bool(true, title="Color Price Candles on BB Breakout", group = GRP_DISPLAY, tooltip="Colors the main price candles when CVD breaks its Bollinger Bands.")
showTable = input.bool(true, "Show Multi-TF Table", group = GRP_DISPLAY)
tablePosition = input.string("top_right", "Table Location", options=["top_left","top_right"], group = GRP_DISPLAY)

// === CONSTANTS for Styling ===
const color BULL_COLOR = color.new(color.green, 20)
const color BEAR_COLOR = color.new(color.red, 20)
const color HIDDEN_BULL_COLOR = color.new(color.green, 20)
const color HIDDEN_BEAR_COLOR = color.new(color.red, 20)
const color BULL_BG_COLOR = color.new(color.green, 80)
const color BEAR_BG_COLOR = color.new(color.red, 80)

// === MA helper ===
ma(s, l, t) =>
    switch t
        "SMA" => ta.sma(s, l)
        "EMA" => ta.ema(s, l)
        "WMA" => ta.wma(s, l)
        => ta.vwma(s, l)  // default VWMA

// Lower TF resolver (works both in main scope and inside request.security)
f_lowerTf() =>
    if useCustomTimeframeInput
        lowerTimeframeInput
    else
        switch
            timeframe.isseconds => "1S"
            timeframe.isintraday => "1" 
            timeframe.isdaily => "5"
            => "60"

// Return CVD "close" from requestVolumeDelta
f_cvdClose() =>
    [_o, _h, _l, _c] = ta.requestVolumeDelta(f_lowerTf(), anchorInput)
    _c 

// === CVD CALCULATION ENGINE ===
[openVolume, maxVolume, minVolume, lastVolume] = ta.requestVolumeDelta(f_lowerTf(), anchorInput)
cvdSource = f_cvdClose()

var float cumVol = 0.0
cumVol += nz(volume)
if barstate.islast and cumVol == 0
    runtime.error("This symbol has no volume data, CVD cannot be calculated.")

// === DIVERGENCE ENGINE ===
plVal = ta.pivotlow(cvdSource, lookbackLeft, lookbackRight)
phVal = ta.pivothigh(cvdSource, lookbackLeft, lookbackRight)
plFound = not na(plVal)
phFound = not na(phVal)
plSince = ta.barssince(plFound)
phSince = ta.barssince(phFound)
inRangePL_now = plSince[1] >= rangeLower and plSince[1] <= rangeUpper
inRangePH_now = phSince[1] >= rangeLower and phSince[1] <= rangeUpper

priceLL = low[lookbackRight] < ta.valuewhen(plFound, low[lookbackRight], 1)
cvdHL   = plVal > ta.valuewhen(plFound, plVal, 1) and inRangePL_now
bullCond = showRegular and priceLL and cvdHL and plFound

priceHH = high[lookbackRight] > ta.valuewhen(phFound, high[lookbackRight], 1)
cvdLH   = phVal < ta.valuewhen(phFound, phVal, 1) and inRangePH_now
bearCond = showRegular and priceHH and cvdLH and phFound

priceHL = low[lookbackRight] > ta.valuewhen(plFound, low[lookbackRight], 1)
cvdLL   = plVal < ta.valuewhen(plFound, plVal, 1) and inRangePL_now
hiddenBullCond = showHidden and priceHL and cvdLL and plFound

priceLH = high[lookbackRight] < ta.valuewhen(phFound, high[lookbackRight], 1)
cvdHH   = phVal > ta.valuewhen(phFound, phVal, 1) and inRangePH_now
hiddenBearCond = showHidden and priceLH and cvdHH and phFound

// === CVD + VOLUME DIVERGENCE ENGINE ===
vol_plVal = ta.pivotlow(volume, lookbackLeft, lookbackRight)
vol_phVal = ta.pivothigh(volume, lookbackLeft, lookbackRight)
vol_plFound = not na(vol_plVal)
vol_phFound = not na(vol_phVal)
vol_plSince = ta.barssince(vol_plFound)
vol_phSince = ta.barssince(vol_phFound)
vol_inRangePL_now = vol_plSince[1] >= rangeLower and vol_plSince[1] <= rangeUpper
vol_inRangePH_now = vol_phSince[1] >= rangeLower and vol_phSince[1] <= rangeUpper
prev_plVal = ta.valuewhen(plFound, plVal, 1)
prev_vol_plVal = ta.valuewhen(vol_plFound, vol_plVal, 1)
prev_phVal = ta.valuewhen(phFound, phVal, 1)
prev_vol_phVal = ta.valuewhen(vol_phFound, vol_phVal, 1)
cvdVolBull = showCvdVolRegular and plFound and vol_plFound and inRangePL_now and vol_inRangePL_now and plVal > prev_plVal and vol_plVal < prev_vol_plVal
cvdVolBear = showCvdVolRegular and phFound and vol_phFound and inRangePH_now and vol_inRangePH_now and phVal < prev_phVal and vol_phVal > prev_vol_phVal

// Plot divergence lines for CVD+Volume (dotted, blue/orange)
var line lineVolBull = na
var line lineVolBear = na
f_plotVolDivLine(line lnIn, bool cond, bool isBear) =>
    ln = lnIn
    found  = isBear ? vol_phFound : vol_plFound
    pivVal = isBear ? vol_phVal   : vol_plVal
    x2 = na(pivVal) ? na : (bar_index - lookbackRight)
    y2 = pivVal
    x1 = ta.valuewhen(found, bar_index - lookbackRight, 1)
    // avoid inline ternary inside function call (Pine parser quirk)
    _volpiv_for_valuewhen = isBear ? vol_phVal : vol_plVal
    y1 = ta.valuewhen(found, _volpiv_for_valuewhen, 1)
    if cond and not na(x1) and not na(y1) and not na(x2) and not na(y2)
        col = isBear ? color.orange : color.blue
        line.delete(ln)
        ln := line.new(x1, y1, x2, y2, color=col, width=2, style=line.style_dotted)
    ln
lineVolBull := f_plotVolDivLine(lineVolBull, cvdVolBull, false)
lineVolBear := f_plotVolDivLine(lineVolBear, cvdVolBear, true)

// Plot CVD+Volume divergence markers on the CVD chart at CVD pivots (like CVD+Price divergences)
f_tagCvdVolDiv(cond, isBear, isHidden) =>
    if cond
        x = bar_index - lookbackRight
        y = isBear ? phVal : plVal
        if not na(y)
            txt = isHidden ? (isBear ? "Hidden VolBear" : "Hidden VolBull") : (isBear ? "VolBear" : "VolBull")
            bg  = isHidden ? (isBear ? color.new(color.orange, 60) : color.new(color.blue, 60)) : (isBear ? color.orange : color.blue)
            sty = isBear ? label.style_label_down : label.style_label_up
            label.new(x=x, y=y, text=txt, style=sty, color=bg, textcolor=color.white, size=isHidden ? size.tiny : size.small)
f_tagCvdVolDiv(cvdVolBull, false, false)
f_tagCvdVolDiv(cvdVolBear, true, false)
f_tagCvdVolDiv(cvdVolBull and not (bullCond or hiddenBullCond), false, true)
f_tagCvdVolDiv(cvdVolBear and not (bearCond or hiddenBearCond), true, true)

// === ARRAY-BASED PERSISTENT CVD+VOLUME DIVERGENCE LINES ===
var float[] bull_xs = array.new_float()
var float[] bull_ys = array.new_float()
var float[] bear_xs = array.new_float()
var float[] bear_ys = array.new_float()
if cvdVolBull and plFound
    array.unshift(bull_xs, bar_index - lookbackRight)
    array.unshift(bull_ys, plVal)
    if array.size(bull_xs) > 50
        array.pop(bull_xs)
        array.pop(bull_ys)
if cvdVolBear and phFound
    array.unshift(bear_xs, bar_index - lookbackRight)
    array.unshift(bear_ys, phVal)
    if array.size(bear_xs) > 50
        array.pop(bear_xs)
        array.pop(bear_ys)
if array.size(bull_xs) > 1 and array.size(bull_ys) > 1
    for i = 1 to math.min(array.size(bull_xs), array.size(bull_ys)) - 1
        x1 = int(array.get(bull_xs, i))
        y1 = array.get(bull_ys, i)
        x2 = int(array.get(bull_xs, i - 1))
        y2 = array.get(bull_ys, i - 1)
        // Only draw if x1, x2 are within 500 bars of bar_index (TradingView's limit)
        if math.abs(bar_index - x1) <= 500 and math.abs(bar_index - x2) <= 500
            line.new(x1, y1, x2, y2, color=color.blue, width=2, style=line.style_dotted)
if array.size(bear_xs) > 1 and array.size(bear_ys) > 1
    for i = 1 to math.min(array.size(bear_xs), array.size(bear_ys)) - 1
        x1 = int(array.get(bear_xs, i))
        y1 = array.get(bear_ys, i)
        x2 = int(array.get(bear_xs, i - 1))
        y2 = array.get(bear_ys, i - 1)
        if math.abs(bar_index - x1) <= 500 and math.abs(bar_index - x2) <= 500
            line.new(x1, y1, x2, y2, color=color.orange, width=2, style=line.style_dotted)
plot(cvdVolBull and plFound ? plVal : na, offset=-lookbackRight, title="CVD+Vol Bullish Div (plot)", linewidth=2, color=color.blue)
plot(cvdVolBear and phFound ? phVal : na, offset=-lookbackRight, title="CVD+Vol Bearish Div (plot)", linewidth=2, color=color.orange)
plot(cvdVolBull and not (bullCond or hiddenBullCond) and plFound ? plVal : na, offset=-lookbackRight, title="CVD+Vol Hidden Bull Div (plot)", linewidth=1, color=color.new(color.blue, 60))
plot(cvdVolBear and not (bearCond or hiddenBearCond) and phFound ? phVal : na, offset=-lookbackRight, title="CVD+Vol Hidden Bear Div (plot)", linewidth=1, color=color.new(color.orange, 60))

// === PLOTTING ===
hline(0, "Zero Line", color.gray, linestyle=hline.style_dashed)
isLinePlot   = plotStyle == "Line with MA"
isCandlePlot = plotStyle == "Candles"
cvdMA = ma(cvdSource, maLengthInput, maTypeInput)
cvdLineColor = cvdSource > cvdSource[1] ? color.blue : color.orange
pCVD = plot(cvdSource, "CVD", color=cvdLineColor, linewidth=2, display=isLinePlot ? display.all : display.none)
pMA  = plot(cvdMA, "CVD MA", color=color.gray, linewidth=1, display=isLinePlot ? display.all : display.none)
fill(pCVD, pMA, color=isLinePlot ? (cvdSource > cvdMA ? color.new(color.blue, 80) : color.new(color.orange, 80)) : na)
cCol = lastVolume >= openVolume ? color.teal : color.red
plotcandle(openVolume, maxVolume, minVolume, lastVolume, "CVD", color=cCol, bordercolor=cCol, wickcolor=cCol, display=isCandlePlot ? display.all : display.none)
cvdMA_bb = ta.sma(cvdSource, maLengthInput)
bbUpper = cvdMA_bb + ta.stdev(cvdSource, maLengthInput) * bbMultInput
bbLower = cvdMA_bb - ta.stdev(cvdSource, maLengthInput) * bbMultInput
plot(bbUpper, "BB Upper", color.gray, style=plot.style_line, display=showBollingerBands ? display.all : display.none)
plot(bbLower, "BB Lower", color.gray, style=plot.style_line, display=showBollingerBands ? display.all : display.none)

// Divergence lines/labels
var line lineBull  = na
var line lineBear  = na
var line lineHBull = na
var line lineHBear = na
// Array lÆ°u id label divergence Ä‘á»ƒ xÃ³a label cÅ© khi vÆ°á»£t quÃ¡ 100
var label[] divLabels = array.new<label>()
divLabelLimit = 100
f_plotDivLine(line lnIn, bool cond, bool isBear, bool isHidden) =>
    ln = lnIn
    found  = isBear ? phFound : plFound
    pivVal = isBear ? phVal   : plVal
    x2 = na(pivVal) ? na : (bar_index - lookbackRight)
    y2 = pivVal
    x1 = ta.valuewhen(found, bar_index - lookbackRight, 1)
    // avoid inline ternary inside function call (Pine parser quirk)
    _piv_for_valuewhen = isBear ? phVal : plVal
    y1 = ta.valuewhen(found, _piv_for_valuewhen, 1)
    if cond and not na(x1) and not na(y1) and not na(x2) and not na(y2)
        col = isHidden ? (isBear ? HIDDEN_BEAR_COLOR : HIDDEN_BULL_COLOR)
                       : (isBear ? BEAR_COLOR        : BULL_COLOR)
        line.delete(ln)
        ln := line.new(x1, y1, x2, y2, color=col, width=isHidden ? 1 : 3, style=isHidden ? line.style_dotted : line.style_solid)
    ln
lineBull  := f_plotDivLine(lineBull,  bullCond,        false, false)
lineBear  := f_plotDivLine(lineBear,  bearCond,        true,  false)
lineHBull := f_plotDivLine(lineHBull, hiddenBullCond,  false, true)
lineHBear := f_plotDivLine(lineHBear, hiddenBearCond,  true,  true)
f_tagDiv(cond, isBear, isHidden) =>
    if cond
        x = bar_index - lookbackRight
        y = isBear ? phVal : plVal
        if not na(y)
            txt = isHidden ? (isBear ? "Hidden Bear" : "Hidden Bull") : (isBear ? "Bear" : "Bull")
            bg  = isBear ? color.new(color.red, 0) : color.new(color.green, 0)
            sty = isBear ? label.style_label_down : label.style_label_up
            lb = label.new(x=x, y=y, text=txt, style=sty, color=bg, textcolor=color.white, size=size.tiny)
            array.unshift(divLabels, lb)
            if array.size(divLabels) > divLabelLimit
                label.delete(array.get(divLabels, -1))
                array.pop(divLabels)
f_tagDiv(bullCond, false, false)
f_tagDiv(bearCond, true,  false)
f_tagDiv(hiddenBullCond, false, true)
f_tagDiv(hiddenBearCond, true,  true)
bgcolor(bullCond or hiddenBullCond ? BULL_BG_COLOR : na, title="Bullish Divergence BG Alert")
bgcolor(bearCond or hiddenBearCond ? BEAR_BG_COLOR : na, title="Bearish Divergence BG Alert")
cvd_is_overbought = cvdSource > bbUpper
cvd_is_oversold = cvdSource < bbLower
barcolor(showCandleColors and cvd_is_overbought ? color.new(color.red, 75) : na, title="CVD Overbought")
barcolor(showCandleColors and cvd_is_oversold ? color.new(color.green, 75) : na, title="CVD Oversold")

// === MULTI-TF TABLE (COMPACT DASHBOARD) ===
cvd_15  = request.security(syminfo.tickerid, "15",  f_cvdClose())
ma_15   = request.security(syminfo.tickerid, "15",  ta.sma(f_cvdClose(), maLengthInput))
cvd_60  = request.security(syminfo.tickerid, "60",  f_cvdClose())
ma_60   = request.security(syminfo.tickerid, "60",  ta.sma(f_cvdClose(), maLengthInput))
cvd_240 = request.security(syminfo.tickerid, "240", f_cvdClose())
ma_240  = request.security(syminfo.tickerid, "240", ta.sma(f_cvdClose(), maLengthInput))
cell_col_15  = cvd_15  > ma_15  ? color.new(color.green, 70) : color.new(color.red, 70)
cell_col_60  = cvd_60  > ma_60  ? color.new(color.green, 70) : color.new(color.red, 70)
cell_col_240 = cvd_240 > ma_240 ? color.new(color.green, 70) : color.new(color.red, 70)
if showTable and barstate.islast
    // Map string -> position enum (follow VSA engine pattern)
    table_pos = tablePosition == "top_right" ? position.top_right : position.top_left
    var table cvdTable = table.new(position=table_pos, columns=2, rows=4, bgcolor=color.new(color.gray, 80), border_width=1, frame_color=color.new(color.gray, 60))
    table.cell(cvdTable, 0, 0, "TF", text_size=size.tiny, bgcolor=color.new(color.gray, 60), text_color=color.white)
    table.cell(cvdTable, 1, 0, "CVD", text_size=size.tiny, bgcolor=color.new(color.gray, 60), text_color=color.white)
    table.cell(cvdTable, 0, 1, "15m", text_size=size.tiny)
    table.cell(cvdTable, 1, 1, str.tostring(cvd_15, format.mintick), bgcolor=cell_col_15, text_color=color.white, text_size=size.tiny)
    table.cell(cvdTable, 0, 2, "1H", text_size=size.tiny)
    table.cell(cvdTable, 1, 2, str.tostring(cvd_60, format.mintick), bgcolor=cell_col_60, text_color=color.white, text_size=size.tiny)
    table.cell(cvdTable, 0, 3, "4H", text_size=size.tiny)
    table.cell(cvdTable, 1, 3, str.tostring(cvd_240, format.mintick), bgcolor=cell_col_240, text_color=color.white, text_size=size.tiny)

// === ALERTS ===
alertcondition(bullCond, "Regular Bullish CVD Divergence", "BetterCVD: Regular Bullish")
alertcondition(bearCond, "Regular Bearish CVD Divergence", "BetterCVD: Regular Bearish")
alertcondition(hiddenBullCond, "Hidden Bullish CVD Divergence", "BetterCVD: Hidden Bullish")
alertcondition(hiddenBearCond, "Hidden Bearish CVD Divergence", "BetterCVD: Hidden Bearish")
alertcondition(cvd_is_overbought, "CVD Overbought (BB Break)", "BetterCVD: CVD Overbought")
alertcondition(cvd_is_oversold, "CVD Oversold (BB Break)", "BetterCVD: CVD Oversold")
alertcondition(cvdVolBull, "CVD+Volume Bullish Divergence", "BetterCVD: CVD+Volume Bullish")
alertcondition(cvdVolBear, "CVD+Volume Bearish Divergence", "BetterCVD: CVD+Volume Bearish")

// === VOLUME COLOR CODING (VSA Wyckoff style) ===
showVolume = input.bool(true, "Show Volume Chart", group=GRP_DISPLAY_NEW)
lengthVolumeMA = input.int(20, title="Length of Volume MA", minval=1, group="Volume Color")
ratioUltraVolume = input.float(2.2, title="Ultra High Volume Ratio", minval=0, group="Volume Color")
ratioVeryHighVolume = input.float(1.8, title="Very High Volume Ratio", minval=0, group="Volume Color")
ratioHighVolume = input.float(1.2, title="High Volume Ratio", minval=0, group="Volume Color")
ratioNormalVolume = input.float(0.8, title="Normal Volume Ratio", minval=0, group="Volume Color")
ratioLowVolume = input.float(0.4, title="Low Volume Ratio", minval=0, group="Volume Color")
volumeMA_vsa = ta.rma(volume, lengthVolumeMA)
ultraHighVolumeMin = volumeMA_vsa * ratioUltraVolume
veryHighVolumeMin = volumeMA_vsa * ratioVeryHighVolume
highVolumeMin = volumeMA_vsa * ratioHighVolume
normalVolumeMin = volumeMA_vsa * ratioNormalVolume
lowVolumeMin = volumeMA_vsa * ratioLowVolume
isUltraHigh = volume >= ultraHighVolumeMin
isVeryHigh = volume >= veryHighVolumeMin and volume < ultraHighVolumeMin
isHigh = volume >= highVolumeMin and volume < veryHighVolumeMin
isNormal = volume >= normalVolumeMin and volume < highVolumeMin
isLow = volume >= lowVolumeMin and volume < normalVolumeMin
isVeryLow = volume < lowVolumeMin
paletteColor = isUltraHigh ? color.new(color.purple, 20) :
               isVeryHigh  ? color.new(color.red, 20) :
               isHigh      ? color.new(color.orange, 20) :
               isNormal    ? color.new(color.green, 20) :
               isLow       ? color.new(color.blue, 20) :
                             color.new(color.gray, 20)
plot(volume, title="Volume", color=paletteColor, style=plot.style_columns, linewidth=1, display=showVolume ? display.all : display.none)

// === VSA SIGNAL PLOTTING & LOGIC ===
volumeMA_vsa2 = ta.sma(volume, vsaVolumeLength)
atr_vsa = ta.atr(14)
spread_vsa = high - low
wideSpread_vsa = spread_vsa > atr_vsa * 1.2
narrowSpread_vsa = spread_vsa < atr_vsa * 0.5
highVolume_vsa = volume > volumeMA_vsa2 * vsaSensitivity
veryHighVolume_vsa = volume > volumeMA_vsa2 * vsaSensitivity * 1.5
lowVolume_vsa = volume < volumeMA_vsa2 * 0.7
ultraHighVolume_vsa = volume > volumeMA_vsa2 * vsaSensitivity * 2.0

// 16 tÃ­n hiá»‡u VSA cÆ¡ báº£n nháº¥t (cÃ³ thá»ƒ báº­t/táº¯t tá»«ng tÃ­n hiá»‡u)
sellingClimax = showSC and veryHighVolume_vsa and close < open and (close - low) / (high - low) < 0.3
buyingClimax = showBC and veryHighVolume_vsa and close > open and (close - low) / (high - low) > 0.7
noDemand = showND and lowVolume_vsa and close > open and (close - low) / (high - low) < 0.6 and close[1] < close[2]
noSupply = showNS and lowVolume_vsa and close < open and (close - low) / (high - low) > 0.4 and close[1] > close[2]
effortToFall = showEF and highVolume_vsa and wideSpread_vsa and close < open and (close - low) / (high - low) > 0.7
effortToRise = showER and highVolume_vsa and wideSpread_vsa and close > open and (close - low) / (high - low) < 0.3
noEffortDown = showNE and lowVolume_vsa and narrowSpread_vsa and close < open
noEffortUp = showNU and lowVolume_vsa and narrowSpread_vsa and close > open
bagHolding = showBH and ultraHighVolume_vsa and wideSpread_vsa and (close - low) / (high - low) < 0.2
upthrust = showUT and highVolume_vsa and high > high[1] and close < close[1] and (close - low) / (high - low) < 0.5
spring = showSP and lowVolume_vsa and low < low[1] and close > low and (close - low) / (high - low) > 0.5
test = showTE and lowVolume_vsa and narrowSpread_vsa and (close - low) / (high - low) > 0.7 and close[1] < close[2]
stoppingVolume = showSV and ultraHighVolume_vsa and narrowSpread_vsa and ((close > open and close[1] < open[1]) or (close < open and close[1] > open[1]))
weakness = showWK and highVolume_vsa and wideSpread_vsa and close > open and (close - low) / (high - low) < 0.5
strength = showST and highVolume_vsa and wideSpread_vsa and close < open and (close - low) / (high - low) > 0.5
shakeout = showSO and highVolume_vsa and low < low[1] and close > close[1] and (close - low) / (high - low) > 0.6


// Gom tÃ­n hiá»‡u VSA trÃªn 1 candle thÃ nh 1 marker duy nháº¥t

// Gom tÃ­n hiá»‡u VSA trÃªn 1 candle thÃ nh 1 marker duy nháº¥t (dÃ¹ng label.new Ä‘á»ƒ text Ä‘á»™ng)
var string[] vsaNames = array.new_string()
var string vsaText = ""
var int vsaType = 0  // 1: bull, -1: bear, 0: neutral
if showVSASignals
    vsaText := ""
    vsaType := 0
    array.clear(vsaNames)
    // Bearish signals
    if noDemand
        array.push(vsaNames, "ND")
        vsaType := vsaType == 1 ? 0 : -1
    if effortToFall
        array.push(vsaNames, "EF")
        vsaType := vsaType == 1 ? 0 : -1
    if noEffortDown
        array.push(vsaNames, "NE")
        vsaType := vsaType == 1 ? 0 : -1
    if bagHolding
        array.push(vsaNames, "BH")
        vsaType := vsaType == 1 ? 0 : -1
    if upthrust
        array.push(vsaNames, "UT")
        vsaType := vsaType == 1 ? 0 : -1
    if weakness
        array.push(vsaNames, "WK")
        vsaType := vsaType == 1 ? 0 : -1
    // Bullish signals
    if sellingClimax
        array.push(vsaNames, "SC")
        vsaType := vsaType == -1 ? 0 : 1
    if buyingClimax
        array.push(vsaNames, "BC")
        vsaType := vsaType == -1 ? 0 : 1
    if noSupply
        array.push(vsaNames, "NS")
        vsaType := vsaType == -1 ? 0 : 1
    if effortToRise
        array.push(vsaNames, "ER")
        vsaType := vsaType == -1 ? 0 : 1
    if noEffortUp
        array.push(vsaNames, "NU")
        vsaType := vsaType == -1 ? 0 : 1
    if spring
        array.push(vsaNames, "SP")
        vsaType := vsaType == -1 ? 0 : 1
    if test
        array.push(vsaNames, "TE")
        vsaType := vsaType == -1 ? 0 : 1
    if stoppingVolume
        array.push(vsaNames, "SV")
        vsaType := vsaType == -1 ? 0 : 1
    if strength
        array.push(vsaNames, "ST")
        vsaType := vsaType == -1 ? 0 : 1
    if shakeout
        array.push(vsaNames, "SO")
        vsaType := vsaType == -1 ? 0 : 1
    // Táº¡o text dáº¡ng A+B+C náº¿u cÃ³ tÃ­n hiá»‡u
    if array.size(vsaNames) > 0
        for i = 0 to array.size(vsaNames) - 1
            vsaText := vsaText == "" ? array.get(vsaNames, i) : vsaText + "+" + array.get(vsaNames, i)
        // Chá»‰ plot náº¿u cÃ³ Ã­t nháº¥t 1 tÃ­n hiá»‡u
        if vsaText != ""
            // Chá»n mÃ u: bull (xanh), bear (Ä‘á»), neutral (xanh dÆ°Æ¡ng)
            vsaColor = vsaType == 1 ? color.green : vsaType == -1 ? color.red : color.blue
            vsaY = cvdSource
            vsaStyle = vsaType == 1 ? label.style_label_up : vsaType == -1 ? label.style_label_down : label.style_label_down
            label.new(bar_index, vsaY, vsaText, style=vsaStyle, color=vsaColor, textcolor=color.white, size=size.tiny)

// === VSA LEGEND TABLE ===
if showVSALegend and barstate.islast
    // Map legendPosition string to position enum
    legend_pos = legendPosition == "bottom_right" ? position.bottom_right : legendPosition == "bottom_left" ? position.bottom_left : legendPosition == "top_right" ? position.top_right : position.top_left
    var table vsaLegend = table.new(position=legend_pos, columns=2, rows=16, bgcolor=color.new(color.gray, 90), border_width=1, frame_color=color.new(color.gray, 60))
    table.cell(vsaLegend, 0, 0, "SC", text_size=size.tiny, text_color=color.red, bgcolor=color.new(color.red, 90))
    table.cell(vsaLegend, 1, 0, "Selling Climax", text_size=size.tiny)
    table.cell(vsaLegend, 0, 1, "BC", text_size=size.tiny, text_color=color.green, bgcolor=color.new(color.green, 90))
    table.cell(vsaLegend, 1, 1, "Buying Climax", text_size=size.tiny)
    table.cell(vsaLegend, 0, 2, "ND", text_size=size.tiny, text_color=color.red, bgcolor=color.new(color.red, 90))
    table.cell(vsaLegend, 1, 2, "No Demand", text_size=size.tiny)
    table.cell(vsaLegend, 0, 3, "NS", text_size=size.tiny, text_color=color.green, bgcolor=color.new(color.green, 90))
    table.cell(vsaLegend, 1, 3, "No Supply", text_size=size.tiny)
    table.cell(vsaLegend, 0, 4, "EF", text_size=size.tiny, text_color=color.red, bgcolor=color.new(color.red, 90))
    table.cell(vsaLegend, 1, 4, "Effort to Fall", text_size=size.tiny)
    table.cell(vsaLegend, 0, 5, "ER", text_size=size.tiny, text_color=color.green, bgcolor=color.new(color.green, 90))
    table.cell(vsaLegend, 1, 5, "Effort to Rise", text_size=size.tiny)
    table.cell(vsaLegend, 0, 6, "NE", text_size=size.tiny, text_color=color.blue, bgcolor=color.new(color.blue, 90))
    table.cell(vsaLegend, 1, 6, "No Effort Down", text_size=size.tiny)
    table.cell(vsaLegend, 0, 7, "NU", text_size=size.tiny, text_color=color.blue, bgcolor=color.new(color.blue, 90))
    table.cell(vsaLegend, 1, 7, "No Effort Up", text_size=size.tiny)
    table.cell(vsaLegend, 0, 8, "BH", text_size=size.tiny, text_color=color.red, bgcolor=color.new(color.red, 90))
    table.cell(vsaLegend, 1, 8, "Bag Holding", text_size=size.tiny)
    table.cell(vsaLegend, 0, 9, "UT", text_size=size.tiny, text_color=color.red, bgcolor=color.new(color.red, 90))
    table.cell(vsaLegend, 1, 9, "Upthrust", text_size=size.tiny)
    table.cell(vsaLegend, 0, 10, "SP", text_size=size.tiny, text_color=color.green, bgcolor=color.new(color.green, 90))
    table.cell(vsaLegend, 1, 10, "Spring", text_size=size.tiny)
    table.cell(vsaLegend, 0, 11, "TE", text_size=size.tiny, text_color=color.green, bgcolor=color.new(color.green, 90))
    table.cell(vsaLegend, 1, 11, "Test", text_size=size.tiny)
    table.cell(vsaLegend, 0, 12, "SV", text_size=size.tiny, text_color=color.green, bgcolor=color.new(color.green, 90))
    table.cell(vsaLegend, 1, 12, "Stopping Volume", text_size=size.tiny)
    table.cell(vsaLegend, 0, 13, "WK", text_size=size.tiny, text_color=color.red, bgcolor=color.new(color.red, 90))
    table.cell(vsaLegend, 1, 13, "Weakness", text_size=size.tiny)
    table.cell(vsaLegend, 0, 14, "ST", text_size=size.tiny, text_color=color.green, bgcolor=color.new(color.green, 90))
    table.cell(vsaLegend, 1, 14, "Strength", text_size=size.tiny)
    table.cell(vsaLegend, 0, 15, "SO", text_size=size.tiny, text_color=color.blue, bgcolor=color.new(color.blue, 90))
    table.cell(vsaLegend, 1, 15, "Shakeout", text_size=size.tiny)

// ============================================================================
// SNIPER EDITION ENHANCEMENTS (From CVPZero)
// ============================================================================

// === VOLUME Z-SCORE CLASSIFICATION (Better than ratio for crypto volatility) ===
f_zscore_vol(src, length) =>
    mean = ta.sma(src, length)
    stdev = ta.stdev(src, length)
    stdev == 0 ? 0 : (src - mean) / stdev

// Adaptive Z-score sensitivity based on timeframe
currentTFMinutes = timeframe.in_seconds() / 60
isLTF = currentTFMinutes <= 15
isHTF = currentTFMinutes >= 60
volZscoreSensitivity = isLTF ? vsa_zscore_sensitivity_ltf : isHTF ? vsa_zscore_sensitivity_htf : 2.0

vol_zscore = f_zscore_vol(volume, vsaVolumeLength)
vol_is_ultra_high_zscore = vol_zscore >= volZscoreSensitivity * 1.5
vol_is_high_zscore = vol_zscore >= volZscoreSensitivity and vol_zscore < volZscoreSensitivity * 1.5
vol_is_normal_zscore = vol_zscore >= volZscoreSensitivity * 0.6 and vol_zscore < volZscoreSensitivity
vol_is_low_zscore = vol_zscore < volZscoreSensitivity * 0.6

// Use Z-Score or Ratio based on vsaClassifierMethod
vol_is_ultra_high_final = vsaClassifierMethod == "zscore" ? vol_is_ultra_high_zscore : isUltraHigh
vol_is_high_final = vsaClassifierMethod == "zscore" ? vol_is_high_zscore : isHigh
vol_is_low_final = vsaClassifierMethod == "zscore" ? vol_is_low_zscore : isLow

// === VSA SIGNAL AGGREGATION (hasVSABullish/Bearish for alerts) ===
// Bullish VSA Signals: SC, BC, NS, ER, NU, SP, TE, SV, ST, SO
hasVSABullish = sellingClimax or buyingClimax or noSupply or effortToRise or noEffortUp or spring or test or stoppingVolume or strength or shakeout
// Bearish VSA Signals: ND, EF, NE, BH, UT, WK
hasVSABearish = noDemand or effortToFall or noEffortDown or bagHolding or upthrust or weakness

// Optional: Require CVD confirmation (filter false signals)
hasVSABullishConfirmed = vsaRequireCvdConfirm ? (hasVSABullish and cvdSource > cvdMA) : hasVSABullish
hasVSABearishConfirmed = vsaRequireCvdConfirm ? (hasVSABearish and cvdSource < cvdMA) : hasVSABearish

// === VSAâ†’DIVERGENCE REVERSAL PATTERN (2-bar Wyckoff Distribution/Accumulation) ===
// Check timeframe meets minimum requirement
isTfEligible = currentTFMinutes >= vsaDivMinTF

// Track if previous bar had VSA signal
var bool prevBarHadVSABull = false
var bool prevBarHadVSABear = false

// Pattern detection:
// Náº¿n 1: VSA Bull -> Náº¿n 2: Divergence Bear = Distribution (top reversal)
// Náº¿n 1: VSA Bear -> Náº¿n 2: Divergence Bull = Accumulation (bottom reversal)
vsaDivBearishReversal = enableVsaDivPattern and isTfEligible and prevBarHadVSABull and (bearCond or hiddenBearCond)
vsaDivBullishReversal = enableVsaDivPattern and isTfEligible and prevBarHadVSABear and (bullCond or hiddenBullCond)

// Update state for next bar
prevBarHadVSABull := hasVSABullishConfirmed
prevBarHadVSABear := hasVSABearishConfirmed

// Visual markers (diamond shape â¬¥)
if showVsaDivMarker and vsaDivBullishReversal
    label.new(bar_index - lookbackRight, plVal, "â¬¥ VSAâ†’DIV", 
      style=label.style_label_up, 
      color=color.new(color.lime, 20), 
      textcolor=color.white, 
      size=size.small,
      tooltip="ğŸ¯ ACCUMULATION PATTERN\n" + 
              "Náº¿n trÆ°á»›c: VSA Bearish (Ã¡p lá»±c bÃ¡n)\n" + 
              "Náº¿n nÃ y: Divergence Bullish (CVD tÄƒng)\n" +
              "âœ Smart money Ä‘ang gom hÃ ng, chuáº©n bá»‹ Ä‘áº£o chiá»u tÄƒng!\n\n" +
              "ENTRY: Long ngay hoáº·c chá» confirm (close > MA)\n" +
              "STOP: DÆ°á»›i low cá»§a náº¿n Divergence\n" +
              "TARGET: 2R Ä‘áº§u tiÃªn, trail 50% cÃ²n láº¡i")

if showVsaDivMarker and vsaDivBearishReversal
    label.new(bar_index - lookbackRight, phVal, "â¬¥ VSAâ†’DIV", 
      style=label.style_label_down, 
      color=color.new(color.fuchsia, 20), 
      textcolor=color.white, 
      size=size.small,
      tooltip="ğŸ¯ DISTRIBUTION PATTERN\n" + 
              "Náº¿n trÆ°á»›c: VSA Bullish (Ã¡p lá»±c mua)\n" + 
              "Náº¿n nÃ y: Divergence Bearish (CVD giáº£m)\n" +
              "âœ Smart money Ä‘ang phÃ¢n phá»‘i, chuáº©n bá»‹ Ä‘áº£o chiá»u giáº£m!\n\n" +
              "ENTRY: Short ngay hoáº·c chá» confirm (close < MA)\n" +
              "STOP: TrÃªn high cá»§a náº¿n Divergence\n" +
              "TARGET: 2R Ä‘áº§u tiÃªn, trail 50% cÃ²n láº¡i")

// ============================================================================
// ADVANCED 7-LEVEL ALERT SYSTEM (Sniper Edition)
// ============================================================================

// === Cáº¤P 1: BASIC DIVERGENCE ALERTS (50-55% Win Rate) ===
// CVD+Price Regular Divergence
c1_bull_cp_reg = enableBasicDivAlerts and bullCond
c1_bear_cp_reg = enableBasicDivAlerts and bearCond
// CVD+Price Hidden Divergence
c1_bull_cp_hid = enableBasicDivAlerts and hiddenBullCond
c1_bear_cp_hid = enableBasicDivAlerts and hiddenBearCond
// CVD+Volume Regular Divergence
c1_bull_cv_reg = enableBasicDivAlerts and cvdVolBull
c1_bear_cv_reg = enableBasicDivAlerts and cvdVolBear
// CVD+Volume Hidden Divergence (detect hidden patterns)
cvdVolBullHidden = showCvdVolHidden and plFound and vol_plFound and inRangePL_now and vol_inRangePL_now and plVal < prev_plVal and vol_plVal < prev_vol_plVal
cvdVolBearHidden = showCvdVolHidden and phFound and vol_phFound and inRangePH_now and vol_inRangePH_now and phVal > prev_phVal and vol_phVal > prev_vol_phVal
c1_bull_cv_hid = enableBasicDivAlerts and cvdVolBullHidden
c1_bear_cv_hid = enableBasicDivAlerts and cvdVolBearHidden

alertcondition(c1_bull_cp_reg, "Cáº¤P 1: C+P Bull Regular", 
  "ğŸ”µ C+P BULL REGULAR\n" +
  "ğŸ“Š GiÃ¡: LL má»›i, CVD: HL\n" +
  "ğŸ¯ Win rate: ~50-55%\n" +
  "ğŸ“ ENTRY: Chá» confirm (close > MA hoáº·c VSA bullish)\n" +
  "ğŸ›‘ STOP: DÆ°á»›i low gáº§n nháº¥t\n" +
  "âœ… TARGET: 1.5R (rá»§i ro tháº¥p)\n" +
  "âš ï¸ Signal nhiá»u, cáº§n ká»¹ nÄƒng lá»c!")

alertcondition(c1_bear_cp_reg, "Cáº¤P 1: C+P Bear Regular", 
  "ğŸ”´ C+P BEAR REGULAR\n" +
  "ğŸ“Š GiÃ¡: HH má»›i, CVD: LH\n" +
  "ğŸ¯ Win rate: ~50-55%\n" +
  "ğŸ“ ENTRY: Chá» confirm (close < MA hoáº·c VSA bearish)\n" +
  "ğŸ›‘ STOP: TrÃªn high gáº§n nháº¥t\n" +
  "âœ… TARGET: 1.5R (rá»§i ro tháº¥p)\n" +
  "âš ï¸ Signal nhiá»u, cáº§n ká»¹ nÄƒng lá»c!")

alertcondition(c1_bull_cp_hid, "Cáº¤P 1: C+P Bull Hidden", "ğŸ”µ C+P BULL HIDDEN\nğŸ“Š Xu hÆ°á»›ng tÄƒng tiáº¿p tá»¥c\nâš ï¸ Setup cho trend follower")
alertcondition(c1_bear_cp_hid, "Cáº¤P 1: C+P Bear Hidden", "ğŸ”´ C+P BEAR HIDDEN\nğŸ“Š Xu hÆ°á»›ng giáº£m tiáº¿p tá»¥c\nâš ï¸ Setup cho trend follower")
alertcondition(c1_bull_cv_reg, "Cáº¤P 1: C+V Bull Regular", "ğŸ”µ C+V BULL REGULAR\nğŸ“Š CVD tÄƒng nhÆ°ng Volume giáº£m\nâš ï¸ Yáº¿u hÆ¡n C+P, cáº§n confirm")
alertcondition(c1_bear_cv_reg, "Cáº¤P 1: C+V Bear Regular", "ğŸ”´ C+V BEAR REGULAR\nğŸ“Š CVD giáº£m nhÆ°ng Volume tÄƒng\nâš ï¸ Yáº¿u hÆ¡n C+P, cáº§n confirm")
alertcondition(c1_bull_cv_hid, "Cáº¤P 1: C+V Bull Hidden", "ğŸ”µ C+V BULL HIDDEN\nğŸ“Š Xu hÆ°á»›ng tÄƒng, volume support")
alertcondition(c1_bear_cv_hid, "Cáº¤P 1: C+V Bear Hidden", "ğŸ”´ C+V BEAR HIDDEN\nğŸ“Š Xu hÆ°á»›ng giáº£m, volume support")

// === Cáº¤P 2: Há»˜I Tá»¤ KÃ‰P (C+P + C+V) (65-75% Win Rate) ===
c2_bull_perfect = enableConfluentAlerts and bullCond and cvdVolBull  // both regular
c2_bear_perfect = enableConfluentAlerts and bearCond and cvdVolBear  // both regular
c2_bull_mixed = enableConfluentAlerts and ((bullCond and cvdVolBullHidden) or (hiddenBullCond and cvdVolBull))
c2_bear_mixed = enableConfluentAlerts and ((bearCond and cvdVolBearHidden) or (hiddenBearCond and cvdVolBear))

alertcondition(c2_bull_perfect, "Cáº¤P 2: Há»™i Tá»¥ KÃ©p BULL (Perfect)", 
  "ğŸŸ¢ğŸŸ¢ PERFECT DOUBLE CONFLUENCE BULL\n" +
  "ğŸ“Š C+P Regular âœ… + C+V Regular âœ…\n" +
  "ğŸ¯ Win rate: ~70-75%\n" +
  "ğŸ’° Risk: 1.5% vá»‘n\n" +
  "ğŸ“ ENTRY: CÃ³ thá»ƒ vÃ o ngay, hoáº·c chá» close > MA\n" +
  "ğŸ›‘ STOP: DÆ°á»›i low cá»§a náº¿n divergence\n" +
  "âœ… TARGET: 2R Ä‘áº§u tiÃªn, trail 50% tá»›i 3R\n" +
  "ğŸ”¥ Setup CHÃNH cho swing trade!")

alertcondition(c2_bear_perfect, "Cáº¤P 2: Há»™i Tá»¥ KÃ©p BEAR (Perfect)", 
  "ğŸ”´ğŸ”´ PERFECT DOUBLE CONFLUENCE BEAR\n" +
  "ğŸ“Š C+P Regular âœ… + C+V Regular âœ…\n" +
  "ğŸ¯ Win rate: ~70-75%\n" +
  "ğŸ’° Risk: 1.5% vá»‘n\n" +
  "ğŸ“ ENTRY: CÃ³ thá»ƒ vÃ o ngay, hoáº·c chá» close < MA\n" +
  "ğŸ›‘ STOP: TrÃªn high cá»§a náº¿n divergence\n" +
  "âœ… TARGET: 2R Ä‘áº§u tiÃªn, trail 50% tá»›i 3R\n" +
  "ğŸ”¥ Setup CHÃNH cho swing trade!")

alertcondition(c2_bull_mixed, "Cáº¤P 2: Há»™i Tá»¥ KÃ©p BULL (Mixed)", "ğŸŸ¢ğŸ”µ MIXED DOUBLE BULL\nğŸ“Š C+P + C+V (1 regular, 1 hidden)\nğŸ¯ Win rate: ~65%\nâš ï¸ HÆ¡i yáº¿u hÆ¡n Perfect, váº«n tradeable")
alertcondition(c2_bear_mixed, "Cáº¤P 2: Há»™i Tá»¥ KÃ©p BEAR (Mixed)", "ğŸ”´ğŸŸ  MIXED DOUBLE BEAR\nğŸ“Š C+P + C+V (1 regular, 1 hidden)\nğŸ¯ Win rate: ~65%\nâš ï¸ HÆ¡i yáº¿u hÆ¡n Perfect, váº«n tradeable")

// === Cáº¤P 3: BB BREAK (Cáº¢M TÃN - WARNING) (45-55% Win Rate) ===
c3_bull_bb = enableBBBreakAlerts and cvd_is_oversold
c3_bear_bb = enableBBBreakAlerts and cvd_is_overbought

alertcondition(c3_bull_bb, "Cáº¤P 3: BB Break OVERSOLD (Cáº£m TÃ­n)", 
  "âš ï¸ CVD QUÃ BÃN (BB Break Down)\n" +
  "ğŸ“Š CVD < BB Lower\n" +
  "ğŸ¯ Win rate: ~45-55% (THáº¤P!)\n" +
  "âŒ KHÃ”NG vÃ o lá»‡nh ngay!\n" +
  "ğŸ‘ï¸ CHá»œ CONFIRM:\n" +
  "  â€¢ Divergence xuáº¥t hiá»‡n (C+P hoáº·c C+V)\n" +
  "  â€¢ VSA bullish signal (SC, SP, NS, TE)\n" +
  "  â€¢ CVD quay láº¡i > BB Lower\n" +
  "ğŸš¨ Crypto cÃ³ thá»ƒ oversold kÃ©o dÃ i! Äá»«ng bottom fishing!")

alertcondition(c3_bear_bb, "Cáº¤P 3: BB Break OVERBOUGHT (Cáº£m TÃ­n)", 
  "âš ï¸ CVD QUÃ MUA (BB Break Up)\n" +
  "ğŸ“Š CVD > BB Upper\n" +
  "ğŸ¯ Win rate: ~45-55% (THáº¤P!)\n" +
  "âŒ KHÃ”NG vÃ o lá»‡nh ngay!\n" +
  "ğŸ‘ï¸ CHá»œ CONFIRM:\n" +
  "  â€¢ Divergence xuáº¥t hiá»‡n (C+P hoáº·c C+V)\n" +
  "  â€¢ VSA bearish signal (BC, ND, UT, WK)\n" +
  "  â€¢ CVD quay láº¡i < BB Upper\n" +
  "ğŸš¨ Crypto cÃ³ thá»ƒ overbought kÃ©o dÃ i! Äá»«ng top fishing!")

// === Cáº¤P 4: VSA + DIVERGENCE CONFLUENCE (65-70% Win Rate) ===
c4_bull_vsa_cp = enableVSAConfluentAlerts and (bullCond or hiddenBullCond) and hasVSABullishConfirmed
c4_bear_vsa_cp = enableVSAConfluentAlerts and (bearCond or hiddenBearCond) and hasVSABearishConfirmed
c4_bull_vsa_cv = enableVSAConfluentAlerts and (cvdVolBull or cvdVolBullHidden) and hasVSABullishConfirmed
c4_bear_vsa_cv = enableVSAConfluentAlerts and (cvdVolBear or cvdVolBearHidden) and hasVSABearishConfirmed

alertcondition(c4_bull_vsa_cp, "Cáº¤P 4: VSA + C+P BULL", 
  "ğŸŸ¢ğŸ’¡ VSA + DIVERGENCE BULL\n" +
  "ğŸ“Š VSA Bullish âœ… + C+P Divergence âœ…\n" +
  "ğŸ¯ Win rate: ~68%\n" +
  "ğŸ’° Risk: 1.5% vá»‘n\n" +
  "ğŸ¦ Smart money footprint!\n" +
  "ğŸ“ ENTRY: VÃ o ngay hoáº·c chá» close > MA\n" +
  "ğŸ›‘ STOP: DÆ°á»›i low cá»§a náº¿n VSA\n" +
  "âœ… TARGET: 2R Ä‘áº§u tiÃªn, trail 50%\n" +
  "ğŸ”¥ Setup CHÃNH, institutional support!")

alertcondition(c4_bear_vsa_cp, "Cáº¤P 4: VSA + C+P BEAR", 
  "ğŸ”´ğŸ’¡ VSA + DIVERGENCE BEAR\n" +
  "ğŸ“Š VSA Bearish âœ… + C+P Divergence âœ…\n" +
  "ğŸ¯ Win rate: ~68%\n" +
  "ğŸ’° Risk: 1.5% vá»‘n\n" +
  "ğŸ¦ Smart money footprint!\n" +
  "ğŸ“ ENTRY: VÃ o ngay hoáº·c chá» close < MA\n" +
  "ğŸ›‘ STOP: TrÃªn high cá»§a náº¿n VSA\n" +
  "âœ… TARGET: 2R Ä‘áº§u tiÃªn, trail 50%\n" +
  "ğŸ”¥ Setup CHÃNH, institutional support!")

alertcondition(c4_bull_vsa_cv, "Cáº¤P 4: VSA + C+V BULL", "ğŸŸ¢ğŸ’¡ VSA + C+V BULL\nğŸ“Š Win rate: ~65%\nâš ï¸ Yáº¿u hÆ¡n VSA+C+P nhÆ°ng váº«n tá»‘t")
alertcondition(c4_bear_vsa_cv, "Cáº¤P 4: VSA + C+V BEAR", "ğŸ”´ğŸ’¡ VSA + C+V BEAR\nğŸ“Š Win rate: ~65%\nâš ï¸ Yáº¿u hÆ¡n VSA+C+P nhÆ°ng váº«n tá»‘t")

// === Cáº¤P 5: TRIPLE CONFLUENCE (HOLY GRAIL) (75-85% Win Rate) ===
c5_bull = enableTripleConfluence and (bullCond or hiddenBullCond) and (cvdVolBull or cvdVolBullHidden) and hasVSABullishConfirmed
c5_bear = enableTripleConfluence and (bearCond or hiddenBearCond) and (cvdVolBear or cvdVolBearHidden) and hasVSABearishConfirmed

alertcondition(c5_bull, "Cáº¤P 5: Há»˜I Tá»¤ BA (HOLY GRAIL) BULL", 
  "ğŸŸ¢ğŸŸ¢ğŸŸ¢ HOLY GRAIL TRIPLE CONFLUENCE BULL\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "âœ… C+P Divergence\n" +
  "âœ… C+V Divergence\n" +
  "âœ… VSA Bullish Signal\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "ğŸ¯ Win rate: 75-85% (CHáº®C Ä‚N NHáº¤T!)\n" +
  "ğŸ’° Risk: 2% vá»‘n (TÄ‚NG LÃŠN!)\n" +
  "ğŸ”¥ Setup hiáº¿m, chá»‰ 1-3 láº§n/thÃ¡ng!\n\n" +
  "ğŸ“ ENTRY: VÃ€O NGAY khÃ´ng chá»!\n" +
  "ğŸ›‘ STOP: DÆ°á»›i low cá»§a náº¿n divergence\n" +
  "âœ… TARGET:\n" +
  "  â€¢ 50% @ 2R\n" +
  "  â€¢ 30% @ 3R\n" +
  "  â€¢ 20% trail tá»›i 5R+\n" +
  "ğŸ¯ Move stop to BE khi hit 1.5R\n\n" +
  "ğŸš€ Äá»ˆNH CAO cá»§a há»‡ thá»‘ng!\n" +
  "ğŸ’ ALL-IN mindset, Ä‘Ã¢y lÃ  cÆ¡ há»™i vÃ ng!")

alertcondition(c5_bear, "Cáº¤P 5: Há»˜I Tá»¤ BA (HOLY GRAIL) BEAR", 
  "ğŸ”´ğŸ”´ğŸ”´ HOLY GRAIL TRIPLE CONFLUENCE BEAR\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "âœ… C+P Divergence\n" +
  "âœ… C+V Divergence\n" +
  "âœ… VSA Bearish Signal\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "ğŸ¯ Win rate: 75-85% (CHáº®C Ä‚N NHáº¤T!)\n" +
  "ğŸ’° Risk: 2% vá»‘n (TÄ‚NG LÃŠN!)\n" +
  "ğŸ”¥ Setup hiáº¿m, chá»‰ 1-3 láº§n/thÃ¡ng!\n\n" +
  "ğŸ“ ENTRY: VÃ€O NGAY khÃ´ng chá»!\n" +
  "ğŸ›‘ STOP: TrÃªn high cá»§a náº¿n divergence\n" +
  "âœ… TARGET:\n" +
  "  â€¢ 50% @ 2R\n" +
  "  â€¢ 30% @ 3R\n" +
  "  â€¢ 20% trail tá»›i 5R+\n" +
  "ğŸ¯ Move stop to BE khi hit 1.5R\n\n" +
  "ğŸš€ Äá»ˆNH CAO cá»§a há»‡ thá»‘ng!\n" +
  "ğŸ’ ALL-IN mindset, Ä‘Ã¢y lÃ  cÆ¡ há»™i vÃ ng!")

// === Cáº¤P 6: EXTREME REVERSAL (BB + DIV) (70-75% Win Rate) ===
c6_bull = enableExtremeAlerts and cvd_is_oversold and (bullCond or hiddenBullCond or cvdVolBull or cvdVolBullHidden)
c6_bear = enableExtremeAlerts and cvd_is_overbought and (bearCond or hiddenBearCond or cvdVolBear or cvdVolBearHidden)

alertcondition(c6_bull, "Cáº¤P 6: EXTREME REVERSAL BULL", 
  "ğŸŸ¢âš¡ EXTREME REVERSAL BULL\n" +
  "ğŸ“Š CVD Oversold (< BB Lower) âœ…\n" +
  "ğŸ“Š Divergence xuáº¥t hiá»‡n âœ…\n" +
  "ğŸ¯ Win rate: ~72%\n" +
  "ğŸ’° Risk: 1.5% vá»‘n\n" +
  "ğŸ”ï¸ Reversal tá»« Cá»°C Äá»˜!\n" +
  "ğŸ“ ENTRY: CÃ³ thá»ƒ vÃ o ngay náº¿u cÃ³ VSA confirm\n" +
  "ğŸ›‘ STOP: DÆ°á»›i low cá»§a vÃ¹ng oversold\n" +
  "âœ… TARGET: 2.5R Ä‘áº§u tiÃªn (bounce máº¡nh), trail 50%\n" +
  "âš ï¸ Náº¿u khÃ´ng cÃ³ VSA, chá» CVD > BB Lower trÆ°á»›c!")

alertcondition(c6_bear, "Cáº¤P 6: EXTREME REVERSAL BEAR", 
  "ğŸ”´âš¡ EXTREME REVERSAL BEAR\n" +
  "ğŸ“Š CVD Overbought (> BB Upper) âœ…\n" +
  "ğŸ“Š Divergence xuáº¥t hiá»‡n âœ…\n" +
  "ğŸ¯ Win rate: ~72%\n" +
  "ğŸ’° Risk: 1.5% vá»‘n\n" +
  "ğŸ”ï¸ Reversal tá»« Cá»°C Äá»˜!\n" +
  "ğŸ“ ENTRY: CÃ³ thá»ƒ vÃ o ngay náº¿u cÃ³ VSA confirm\n" +
  "ğŸ›‘ STOP: TrÃªn high cá»§a vÃ¹ng overbought\n" +
  "âœ… TARGET: 2.5R Ä‘áº§u tiÃªn (dump máº¡nh), trail 50%\n" +
  "âš ï¸ Náº¿u khÃ´ng cÃ³ VSA, chá» CVD < BB Upper trÆ°á»›c!")

// === Cáº¤P 7: VSAâ†’DIVERGENCE REVERSAL PATTERN (Sniper Setup) (75-80% Win Rate) ===
alertcondition(vsaDivBullishReversal and vsaDivAlertEnabled and enableVsaDivRevAlerts, 
  "Cáº¤P 7: VSAâ†’DIV REVERSAL BULL (Sniper Setup)", 
  "ğŸ¯ğŸ’ VSAâ†’DIVERGENCE ACCUMULATION PATTERN\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "ğŸ“Š WYCKOFF ACCUMULATION:\n" +
  "  Náº¿n 1: VSA Bearish (smart money bÃ¡n Ã©p)\n" +
  "  Náº¿n 2: Divergence Bullish (CVD tÄƒng)\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "ğŸ¯ Win rate: 75-80% (SNIPER SETUP!)\n" +
  "ğŸ’° Risk: 2% vá»‘n\n" +
  "ğŸ¦ Smart money Ä‘ang gom hÃ ng!\n\n" +
  "ğŸ“ ENTRY:\n" +
  "  â€¢ Option 1: VÃ€O NGAY (aggressive)\n" +
  "  â€¢ Option 2: Chá» close > MA (conservative)\n" +
  "ğŸ›‘ STOP: DÆ°á»›i low cá»§a náº¿n Divergence\n" +
  "âœ… TARGET:\n" +
  "  â€¢ 50% @ 2R\n" +
  "  â€¢ 30% @ 3R\n" +
  "  â€¢ 20% trail tá»›i 5R+\n\n" +
  "ğŸ”¥ Pattern máº¡nh nháº¥t cho 1H-4H!\n" +
  "ğŸ¯ Timeframe hiá»‡n táº¡i: " + timeframe.period + "\n" +
  "âœ¨ ÄÃ¢y lÃ  setup 'báº¯n voi' cá»§a sniper!")

alertcondition(vsaDivBearishReversal and vsaDivAlertEnabled and enableVsaDivRevAlerts, 
  "Cáº¤P 7: VSAâ†’DIV REVERSAL BEAR (Sniper Setup)", 
  "ğŸ¯ğŸ’ VSAâ†’DIVERGENCE DISTRIBUTION PATTERN\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "ğŸ“Š WYCKOFF DISTRIBUTION:\n" +
  "  Náº¿n 1: VSA Bullish (smart money mua Ä‘áº©y)\n" +
  "  Náº¿n 2: Divergence Bearish (CVD giáº£m)\n" +
  "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
  "ğŸ¯ Win rate: 75-80% (SNIPER SETUP!)\n" +
  "ğŸ’° Risk: 2% vá»‘n\n" +
  "ğŸ¦ Smart money Ä‘ang phÃ¢n phá»‘i!\n\n" +
  "ğŸ“ ENTRY:\n" +
  "  â€¢ Option 1: VÃ€O NGAY (aggressive)\n" +
  "  â€¢ Option 2: Chá» close < MA (conservative)\n" +
  "ğŸ›‘ STOP: TrÃªn high cá»§a náº¿n Divergence\n" +
  "âœ… TARGET:\n" +
  "  â€¢ 50% @ 2R\n" +
  "  â€¢ 30% @ 3R\n" +
  "  â€¢ 20% trail tá»›i 5R+\n\n" +
  "ğŸ”¥ Pattern máº¡nh nháº¥t cho 1H-4H!\n" +
  "ğŸ¯ Timeframe hiá»‡n táº¡i: " + timeframe.period + "\n" +
  "âœ¨ ÄÃ¢y lÃ  setup 'báº¯n voi' cá»§a sniper!")

// ============================================================================
// END OF SNIPER EDITION ENHANCEMENTS
// ============================================================================