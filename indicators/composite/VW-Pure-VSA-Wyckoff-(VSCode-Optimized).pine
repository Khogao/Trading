//@version=5
indicator("VW - Pure VSA/Wyckoff (VSCode Optimized)", "VW-Optimized", overlay=true)

// === 1. CÀI ĐẶT RIÊNG CHO TỪNG TF (DỄ QUẢN LÝ TRONG VSCode) ===
// 1m Settings
volLookback_1m = input.int(8, "1m Vol Lookback", minval=3, maxval=20)
highVolThreshold_1m = input.float(1.8, "1m High Vol Thresh", minval=1.0, step=0.1)
lowVolThreshold_1m = input.float(0.6, "1m Low Vol Thresh", maxval=1.0, step=0.1)
swingLookback_1m = input.int(5, "1m Swing Lookback", minval=3, maxval=15)

// 5m Settings
volLookback_5m = input.int(10, "5m Vol Lookback", minval=5, maxval=25)
highVolThreshold_5m = input.float(1.6, "5m High Vol Thresh", minval=1.0, step=0.1)
lowVolThreshold_5m = input.float(0.65, "5m Low Vol Thresh", maxval=1.0, step=0.1)
swingLookback_5m = input.int(7, "5m Swing Lookback", minval=5, maxval=20)

// 15m/30m Settings
volLookback_15m = input.int(12, "15m Vol Lookback", minval=8, maxval=30)
highVolThreshold_15m = input.float(1.5, "15m High Vol Thresh", minval=1.0, step=0.1)
lowVolThreshold_15m = input.float(0.7, "15m Low Vol Thresh", maxval=1.0, step=0.1)
swingLookback_15m = input.int(10, "15m Swing Lookback", minval=8, maxval=25)

// 1h Settings
volLookback_1h = input.int(15, "1h Vol Lookback", minval=10, maxval=35)
highVolThreshold_1h = input.float(1.4, "1h High Vol Thresh", minval=1.0, step=0.1)
lowVolThreshold_1h = input.float(0.75, "1h Low Vol Thresh", maxval=1.0, step=0.1)
swingLookback_1h = input.int(12, "1h Swing Lookback", minval=10, maxval=30)

// 4h Settings
volLookback_4h = input.int(20, "4h Vol Lookback", minval=15, maxval=40)
highVolThreshold_4h = input.float(1.3, "4h High Vol Thresh", minval=1.0, step=0.1)
lowVolThreshold_4h = input.float(0.8, "4h Low Vol Thresh", maxval=1.0, step=0.1)
swingLookback_4h = input.int(15, "4h Swing Lookback", minval=15, maxval=35)

// 1d Settings
volLookback_1d = input.int(25, "1d Vol Lookback", minval=20, maxval=50)
highVolThreshold_1d = input.float(1.2, "1d High Vol Thresh", minval=1.0, step=0.1)
lowVolThreshold_1d = input.float(0.85, "1d Low Vol Thresh", maxval=1.0, step=0.1)
swingLookback_1d = input.int(20, "1d Swing Lookback", minval=20, maxval=40)

// === 2. TỐI ƯU CHO VSCode (KHÔNG LỖI CÚ PHÁP) ===
f_getSettings() =>
    tf = timeframe.period

    switch tf
        "1" => [volLookback_1m, highVolThreshold_1m, lowVolThreshold_1m, swingLookback_1m]
        "5" => [volLookback_5m, highVolThreshold_5m, lowVolThreshold_5m, swingLookback_5m]
        "15" => [volLookback_15m, highVolThreshold_15m, lowVolThreshold_15m, swingLookback_15m]
        "30" => [volLookback_15m, highVolThreshold_15m, lowVolThreshold_15m, swingLookback_15m]
        "60" => [volLookback_1h, highVolThreshold_1h, lowVolThreshold_1h, swingLookback_1h]
        "240" => [volLookback_4h, highVolThreshold_4h, lowVolThreshold_4h, swingLookback_4h]
        "D" => [volLookback_1d, highVolThreshold_1d, lowVolThreshold_1d, swingLookback_1d]
        "1D" => [volLookback_1d, highVolThreshold_1d, lowVolThreshold_1d, swingLookback_1d]
        => [20, 1.5, 0.7, 10] // Default

// === 3. LOẠI BỎ MỌI THỨ KHÔNG CẦN THIẾT ===
[volLookback, highVolThreshold, lowVolThreshold, swingLookback] = f_getSettings()

// Volume Context
volumeAvg = ta.sma(volume, volLookback)
volumeRank = 0.0
for i = 1 to volLookback
    volumeRank += volume > volume[i] ? 1 : 0
volumePctRank = volumeRank / volLookback * 100
isHighVol = volume > volumeAvg * highVolThreshold
isLowVol = volume < volumeAvg * lowVolThreshold

// Bar Characteristics
barRange = high - low
closeLocation = barRange != 0 ? (close - low) / barRange : 0.5
isNarrow = barRange < ta.atr(14) * 0.7
isWide = barRange > ta.atr(14) * 1.3
isUp = close > open
isDown = close < open

// === 4. DETECT TÍN HIỆU (CÚ PHÁP TỐI ƯU CHO VSCode) ===
// Spring Detection
detectSpring() =>
    bool isValid = false
    string reasons = ""
    float strength = 0.0
    
    swingLow = ta.lowest(low, swingLookback)[1]
    bool priceFailure = low < swingLow and close > swingLow
    bool volConfirm = isHighVol or volumePctRank > 70
    bool strongClose = closeLocation > 0.5
    
    if priceFailure
        reasons += "• Price broke support & recovered\n"
        strength += 2.0
    if volConfirm
        reasons += "• High volume confirmation\n"
        strength += 1.5
    if strongClose
        reasons += "• Strong close\n"
        strength += 1.0
    
    [strength, reasons]

// (Các hàm detect khác được viết tương tự)

// === 5. XỬ LÝ CHÍNH (TỐI ƯU HIỆU SUẤT) ===
var allSignals = array.new<string>()
var allStrengths = array.new<float>()

// Call detectSpring() on every calculation
[springStrength, springReasons] = detectSpring()

if barstate.isconfirmed
    // Use the already-calculated values
    if springStrength > 0
        array.push(allSignals, "Spring")
        array.push(allStrengths, springStrength)
    
    // Xử lý các tín hiệu khác...

// === 6. HIỂN THỊ (KHÔNG DÙNG TABLE - TỐI ƯU CHO VSCode) ===
if array.size(allSignals) > 0
    string output = ""
    for i = 0 to array.size(allSignals) - 1
        output := output + array.get(allSignals, i) + " (" + str.tostring(array.get(allStrengths, i), "#.#") + "):" + "\n"
    label.new(
        x=bar_index,
        y=low,
        text=output,
        style=label.style_label_center,
        color=color.new(color.gray, 70),
        textcolor=color.white,
        size=size.small
    )