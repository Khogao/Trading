// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © lenguyenphi

//@version=5
indicator("EZ", overlay=true, max_boxes_count=5)

vol_multiplier = input.float(2.0, title="Volume Spike Multiplier", minval=1.0)
trap_zone_length = input.int(3, title="Trap Zone Length (bars)")
lookback = input.int(20, title="Volume Lookback Period")
show_sr = input.bool(true, title="Show Auto S/R")
show_rsi_div = input.bool(true, title="Show RSI Divergence")
div_lookback = input.int(20, title="RSI Div Lookback")
max_trap_boxes = 5

// VSA Wyckoff Trap Zone logic
avg_vol = ta.sma(volume, lookback)
vol_spike = volume > avg_vol * vol_multiplier

is_pin_bar(bull) =>
    body = math.abs(close - open)
    wick = bull ? (close - low) : (high - close)
    wick > body * 2

bull_pin = vol_spike and is_pin_bar(true) and close > open
bear_pin = vol_spike and is_pin_bar(false) and close < open
bull_engulf = vol_spike and close > open and close > ta.highest(close[1], trap_zone_length)
bear_engulf = vol_spike and close < open and close < ta.lowest(close[1], trap_zone_length)
trap_bull = bull_pin or bull_engulf
trap_bear = bear_pin or bear_engulf

// Auto S/R
sr_len = 40
sr_width = 1
sr_color = color.new(color.blue, 70)
support = ta.lowest(low, sr_len)
resist = ta.highest(high, sr_len)
plot(show_sr ? support : na, color=sr_color, linewidth=sr_width, style=plot.style_linebr, title="Sup")
plot(show_sr ? resist : na, color=sr_color, linewidth=sr_width, style=plot.style_linebr, title="Res")

// Trap zone chỉ nhận khi gần SR (lọc tín hiệu trap yếu)
is_in_sr_zone = (math.abs(low-support)/support < 0.002) or (math.abs(high-resist)/resist < 0.002)
final_trap_bull = trap_bull and is_in_sr_zone
final_trap_bear = trap_bear and is_in_sr_zone

// Quản lý số lượng box trap zone
var box[] trap_boxes = array.new<box>()
if final_trap_bull
    new_box = box.new(left=bar_index, top=high, right=bar_index + trap_zone_length, bottom=low)
    box.set_bgcolor(new_box, color.new(color.green, 80))
    box.set_border_color(new_box, color.green)
    array.unshift(trap_boxes, new_box)
if final_trap_bear
    new_box = box.new(left=bar_index, top=high, right=bar_index + trap_zone_length, bottom=low)
    box.set_bgcolor(new_box, color.new(color.red, 80))
    box.set_border_color(new_box, color.red)
    array.unshift(trap_boxes, new_box)
while array.size(trap_boxes) > max_trap_boxes
    box.delete(array.pop(trap_boxes))

// Entry signal (tối giản)
entry_buy = final_trap_bull and close > open and close[1] < open[1]
entry_sell = final_trap_bear and close < open and close[1] > open[1]
plotshape(entry_buy, title="B", style=shape.triangleup, location=location.belowbar, color=color.lime, size=size.tiny, text="B")
plotshape(entry_sell, title="S", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.tiny, text="S")
alertcondition(entry_buy, title="Buy Entry Alert", message="Trap Scalping BUY (B)!")
alertcondition(entry_sell, title="Sell Entry Alert", message="Trap Scalping SELL (S)!")

// RSI Divergence logic (siêu gọn, lookback động)
rsi_len = 14
rsi = ta.rsi(close, rsi_len)
bull_div = low < ta.lowest(low, div_lookback) and rsi > ta.lowest(rsi, div_lookback)
bear_div = high > ta.highest(high, div_lookback) and rsi < ta.highest(rsi, div_lookback)
plotshape(show_rsi_div and bull_div, style=shape.triangleup, location=location.belowbar, color=color.aqua, size=size.tiny, text="BD", title="BD")
plotshape(show_rsi_div and bear_div, style=shape.triangledown, location=location.abovebar, color=color.orange, size=size.tiny, text="SD", title="SD")
alertcondition(show_rsi_div and bull_div, title="RSI Bull Div", message="RSI BD!")
alertcondition(show_rsi_div and bear_div, title="RSI Bear Div", message="RSI SD!")
